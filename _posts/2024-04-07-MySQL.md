layout: post
title: MySQL
date: 2024-04-07

tags: MySQL
--- 



# 						一: MySql二进制部署:

## 1.1: MySQL 8.0部署:

## 1.2：安装包下载

官方网站：

https://www.mysql.com/



![](/images/posts/10_mysql/1.png)



![](/images/posts/10_mysql/2.png)





![](/images/posts/10_mysql/3.png)



![](/images/posts/10_mysql/4.png)





![](/images/posts/10_mysql/5.png)



## 1.3：配置Host文件

```bash
echo "192.168.48.147  mysql">>  /etc/hosts
cat /etc/hosts
```



### 1.3.1: 卸载主机自带的mysql

```bash
#rpm -qa | grep mysql
#rpm -e --nodeps *mysql*
#rpm -qa | grep mariadb
#rpm -e --nodeps mariadb
```

## 1.4: 安装mysql8.0

```bash
[root@mysql src]# pwd
/usr/local/src
[root@mysql src]# tar -xvf mysql-8.0.16-linux-glibc2.12-x86_64.tar
[root@mysql src]# rm -rf mysql-8.0.16-linux-glibc2.12-x86_64.tar
[root@mysql src]# xz -d mysql-8.0.16-linux-glibc2.12-x86_64.tar.xz
[root@mysql src]# tar -xvf mysql-8.0.16-linux-glibc2.12-x86_64.tar
[root@mysql src]# mv mysql-8.0.16-linux-glibc2.12-x86_64 /usr/local/mysql
[root@mysql mysql]# mkdir /var/lib/mysql
[root@mysql mysql]# mkdir /-p /usr/local/mysql/log
[root@mysql mysql]# mkdir /usr/local/mysql/data

[root@mysql mysql]# cat ~/.bash_profile
PATH=$PATH:/usr/local/mysql/bin:$HOME/bin
[root@mysql mysql]# source ~/.bash_profile

[root@mysql mysql]# groupadd mysql
[root@mysql mysql]# useradd -r -g mysql -s /bin/false mysql
[root@mysql mysql]# chown -R mysql.mysql /usr/local/mysql
[root@mysql mysql]# chown -R mysql.mysql /var/lib/mysql/

#配置参数文件
[mysql] 
default-character-set=utf8mb4 
socket=/var/lib/mysql/mysql.sock 
[mysqld] 
port = 3306 
socket=/var/lib/mysql/mysql.sock 
basedir=/usr/local/mysql 
character-set-server=utf8mb4 
default-storage-engine=INNODB
innodb_buffer_pool_size = 200M
max_allowed_packet=16M 
explicit_defaults_for_timestamp=1
log-output=FILE
general_log = 0 
general_log_file=/usr/local/mysql/log/fgedu02-general.err
slow_query_log = ON
slow_query_log_file=/usr/local/mysql/log/fgedu02-query.err
long_query_time=10
log-error=/usr/local/mysql/log/fgedu02-error.err
default-authentication-plugin=mysql_native_password

#MySQL数据库初始化
[root@mysql mysql]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql/ --datadir=/usr/local/mysql/data/

[root@mysql mysql]# cd /usr/local/mysql/log
[root@mysql log]# tail -100f fgedu02-error.err
2022-08-12T04:45:47.907918Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: j2h/buSexspp
```

### 1.4.1: 配置启动和停止脚本

```bash
[root@mysql log]# cat /usr/lib/systemd/system/mysqld.service
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf
LimitNOFILE = 65536
LimitNPROC = 65536 
```

### 1.4.2: 启动和停止

```bash
[root@mysql log]# systemctl daemon-reload
[root@mysql log]# systemctl enable mysqld
[root@mysql log]# systemctl stop mysqld
[root@mysql log]# systemctl start mysqld
[root@mysql log]# systemctl status mysqld

```

### 1.4.3：修改root密码

```bash
mysql> use mysql;
ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.
mysql> ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'rootroot';
Query OK, 0 rows affected (0.01 sec)

mysql> exit
Bye

```

#### 1.4.3.1: 允许root远程登录

```bash
[root@mysql log]# mysql -u root -p
mysql> use mysql;
mysql> select host,user from user where user='root';
mysql> create USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'root';
mysql> grant all privileges on *.* to 'root'@'%' with grant option;
mysql> exit
Bye
[root@mysql log]# mysql -uroot -p -h 192.168.48.147
```



### 1.4.4: 创建数据库

```bash
mysql> create database test DEFAULT CHARSET utf8mb4


#创建test用户
mysql> CREATE USER 'test'@'%' IDENTIFIED BY 'test';
Query OK, 0 rows affected (0.00 sec)
#查看所有用户
mysql> SELECT HOST,USER FROM mysql.user;

#为test用户分配权限
mysql> GRANT ALL PRIVILEGES ON test.* to 'test'@'%' WITH GRANT OPTION;

```

#### 1.4.4.1：创建表

```bash
mysql> create table test(id int auto_increment primary key,name varchar(15)) engine=InnoDB;
```

#### 1.4.4.2: 插入数据

```bash
mysql> INSERT INTO test VALUES(1,'v1');
Query OK, 1 row affected (0.03 sec)

mysql> INSERT INTO test VALUES(2,'v2');
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO test VALUES(3,'v3');
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO test VALUES(4,'v4');
Query OK, 1 row affected (0.01 sec)

```

#### 1.4.4.3: 查询数据

```bash
mysql> use test;
Database changed
mysql> select * from test;
+----+------+
| id | name |
+----+------+
|  1 | v1   |
|  2 | v2   |
|  3 | v3   |
|  4 | v4   |
+----+------+
4 rows in set (0.00 sec)

```



## 2.1：MySQL 5.7部署

## 2.1： 安装包下载

https://www.mysql.com/



![](/images/posts/10_mysql/6.png)



![](/images/posts/10_mysql/7.png)





![](/images/posts/10_mysql/8.png)



![](/images/posts/10_mysql/9.png)







![](/images/posts/10_mysql/10.png)





## 2.3：配置Host文件

```bash
echo "192.168.48.147  mysql">>  /etc/hosts
cat /etc/hosts
```



### 1.3.1: 卸载主机自带的mysql

```bash
#rpm -qa | grep mysql
#rpm -e --nodeps *mysql*
#rpm -qa | grep mariadb
#rpm -e --nodeps mariadb
#yum remove mariadb-*
```

## 2.4: 安装mysql5.7 

```bash
[root@mysql ]#mdkir -p /app
[root@mysql ]#cd /app
[root@mysql app]#mkdir /data
[root@mysql app]#mkdir /data/conf
[root@mysql app]#mkdir /data/log
[root@mysql app]#mkdir /data/mysql
[root@mysql app]#wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz
[root@localhost app]# tar -xf mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz 
[root@localhost app]# mv mysql-5.7.25-linux-glibc2.12-x86_64 mysql

[root@mysql mysql]# cat vim /etc/profile
export PATH=/app/mysql/bin:$PATH
[root@mysql mysql]# source /etc/profile

[root@mysql mysql]# groupadd mysql
[root@mysql mysql]# useradd -r -g mysql -s /bin/false mysql
[root@mysql mysql]# chown -R mysql.mysql /app
```



### 2.4.1：数据库初始化:

```bash
方式一
#数据库初始化,初始化管理员的临时密码
[root@localhost app]# mysqld --initialize --user=mysql --basedir=/app/mysql --datadir=/data/mysql
2023-12-20T21:24:15.671528Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2023-12-20T21:24:15.824487Z 0 [Warning] InnoDB: New log files created, LSN=45790
2023-12-20T21:24:15.854808Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.
2023-12-20T21:24:15.872865Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 20b8997d-9f7e-11ee-915a-000c2903d870.
2023-12-20T21:24:15.873782Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.
2023-12-20T21:24:15.874640Z 1 [Note] A temporary password is generated for root@localhost: hfGfosmiU9=T


#方式二:
初始化数据，初始化管理员的密码为空
[root@localhost app]#mysqld --initialize-insecure  --user=mysql --basedir=/app/mysql --datadir=/data/mysql


[root@localhost mysql]# ll
total 110628
-rw-r-----. 1 mysql mysql       56 Dec 21 05:24 auto.cnf
-rw-r-----. 1 mysql mysql      419 Dec 21 05:24 ib_buffer_pool
-rw-r-----. 1 mysql mysql 12582912 Dec 21 05:24 ibdata1
-rw-r-----. 1 mysql mysql 50331648 Dec 21 05:24 ib_logfile0
-rw-r-----. 1 mysql mysql 50331648 Dec 21 05:24 ib_logfile1
drwxr-x---. 2 mysql mysql     4096 Dec 21 05:24 mysql
drwxr-x---. 2 mysql mysql     8192 Dec 21 05:24 performance_schema
drwxr-x---. 2 mysql mysql     8192 Dec 21 05:24 sys
[root@localhost mysql]# pwd
/data/mysql

```



### 2.4.2: 配置参数:

```bash



#配置参数文件
# cat /etc/my.cnf 
[mysqld]
user=mysql
basedir=/app/mysql
datadir=/data/mysql
port=3306
default-storage-engine=INNODB
socket=/data/mysql.sock
[mysql]
default-character-set=utf8 
socket=/data/mysql.sock
#可选
[root@etcd src]# cat /app/conf/my.cnf
[mysql] 
default-character-set=utf8 
socket=/app/data/mysql.sock 
[mysqld] 
port = 3306 
socket=/app/data/mysql.sock 
basedir=/mysql/app/mysql
datadir=/mysql/data/3306/data
character-set-server=utf8 
default-storage-engine=INNODB 
innodb_buffer_pool_size = 200M
max_allowed_packet=16M 
explicit_defaults_for_timestamp=1
log-output=FILE
general_log = 0 
general_log_file=/mysql/log/3306/itpuxdb-general.err
slow_query_log = ON
slow_query_log_file=/mysql/log/3306/itpuxdb-query.err
long_query_time=10
log-error=/mysql/log/3306/itpuxdb-error.err
```



### 2.4.3: 配置启动和停止脚本

```bash
#/etc/启动方式
[root@localhost support-files]# pwd
/app/mysql/support-files
[root@localhost support-files]# cp mysql.server /etc/init.d/mysqld
[root@localhost support-files]# /etc/init.d/mysqld start
Starting MySQL. SUCCESS!
[root@localhost support-files]# mysql -uroot -p'cd:8moK%,vC-'
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.25

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 

#停止数据库
[root@localhost support-files]# /etc/init.d/mysqld stop
Shutting down MySQL.. SUCCESS! 


#使用systemctl启动方式
[root@mysql log]# cat /etc/systemd/system/mysqld.service
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/etc/my.cnf
LimitNOFILE = 65536
LimitNPROC = 65536
```

### 2.4.3：修改root密码

```bash

mysql> use mysql;
ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.
mysql> ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';
Query OK, 0 rows affected (0.01 sec)

mysql> exit
Bye

```

#### 2.4.3.1: 允许root远程登录

```bash
[root@localhost support-files]# mysql -uroot -p'root'
mysql> use mysql;
mysql> select host,user from user where user='root';
mysql> grant all privileges on *.* to 'root'@'%' with grant option;
mysql> exit
Bye
[root@mysql log]# mysql -uroot -p -h 192.168.48.147
```



### 2.4.4: 创建数据库

```bash
mysql> create database test DEFAULT CHARSET utf8;

#创建test用户
mysql> CREATE USER 'test'@'%' IDENTIFIED BY 'test';
Query OK, 0 rows affected (0.00 sec)
#查看所有用户
mysql> SELECT HOST,USER FROM mysql.user;

#为test用户分配权限
mysql> GRANT ALL PRIVILEGES ON test.* to 'test'@'%' identified by 'test';


```

#### 2.4.4.1：创建表

```bash
mysql> use test;
mysql> create table test(id int auto_increment primary key,name varchar(15)) engine=InnoDB;
```

#### 2.4.4.2: 插入数据

```bash
mysql> INSERT INTO test VALUES(1,'v1');
Query OK, 1 row affected (0.03 sec)

mysql> INSERT INTO test VALUES(2,'v2');
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO test VALUES(3,'v3');
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO test VALUES(4,'v4');
Query OK, 1 row affected (0.01 sec)

```

#### 2.4.4.3: 查询数据

```bash
mysql> use test;
Database changed
mysql> select * from test;
+----+------+
| id | name |
+----+------+
|  1 | v1   |
|  2 | v2   |
|  3 | v3   |
|  4 | v4   |
+----+------+
4 rows in set (0.00 sec)

```



# 二: MySQL-体系构建与管理:



## 2.1: 体系机构:

### 2.1.1: C/S客户端-服务端:



![](/images/posts/10_mysql/11.png)



## 2.2: Mysql程序运行原理:

### 2.2.1: Mysql程序结构:



![](/images/posts/10_mysql/12.png)



### 2.2.2: 一条SQL语句的执行过程:

```bash
（1）提供连接协议：TCP/IP 、SOCKET
（2）提供验证：用户、密码，IP，SOCKET
（3）提供专用连接线程：接收用户SQL，返回结果
通过以下语句可以查看到连接线程基本情况
mysql> show processlist;
```



#### 2.2.2.1: 存储引擎层:

```bash
负责根据SQL层执行的结果，从磁盘上拿数据。
将16进制的磁盘数据，交由SQL结构化化成表，
连接层的专用线程返回给用户。
```



### 2.2.3: 表的物理存储结构:

```bash
MyISAM（一种引擎）的表：
-rw-r----- 1 mysql mysql   10816 Apr 18 11:37 user.frm  #列的先关信息
-rw-r----- 1 mysql mysql     396 Apr 18 12:20  user.MYD  #数据行
-rw-r----- 1 mysql mysql    4096 Apr 18 14:48 user.MYI  #索引

InnoDB(默认的存储引擎)的表：
-rw-r----- 1 mysql mysql    8636 Apr 18 11:37 time_zone.frm #存储列相关的信息
-rw-r----- 1 mysql mysql   98304 Apr 18 11:37 time_zone.ibd #数据行+索引
time_zone.frm：存储列相关信息
time_zone.ibd：数据行+索引
```



## 2.3: 用户、权限管理:

### 2.3.1: 用户管理:

```bash
#创建用户
mysql> create user app@'%' identified by '123';
Query OK, 0 rows affected (0.00 sec)
#查看用户
mysql> select user,host from mysql.user;
+---------------+-----------+
| user          | host      |
+---------------+-----------+
| app           | %         |
| mysql.session | localhost |
| mysql.sys     | localhost |
| root          | localhost |
+---------------+-----------+
4 rows in set (0.00 sec)
#删除用户
mysql> drop user app;
Query OK, 0 rows affected (0.00 sec)

#更改用户密码
mysql> alter user app@'%' identified by 'abc';
Query OK, 0 rows affected (0.00 sec)

```



## 2.3.2: 权限管理:

```bash
ALL:
SELECT,INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE
ALL : 以上所有权限，一般是普通管理员拥有的
with grant option：超级管理员才具备的，给别的用户授权的功能


*.*                  ---->管理员用户
wordpress.*          ---->开发和应用用户
wordpress.t1  

#权限管理操作:
grant 权限 on 对象 to 用户 identified by '123';

grant all on wordpress.* to app@'%' identified by '123';

#查看权限
mysql> show grants for app@'%';
+------------------------------------------+
| Grants for app@%                         |
+------------------------------------------+
| GRANT ALL PRIVILEGES ON *.* TO 'app'@'%' |
+------------------------------------------+
1 row in set (0.00 sec)


#回收权限

mysql> revoke all on *.* from app@'%';
Query OK, 0 rows affected (0.00 sec)
```



### 2.3.3：本地管理员用户密码忘记:

```bash
[root@localhost mysql]# systemctl stop mysqld
[root@db01 ~]# mysqld_safe --skip-grant-tables  --skip-networking &
[1] 24139
[root@localhost mysql]# Logging to '/data/mysql/localhost.localdomain.err'.
2023-12-21T13:56:49.159028Z mysqld_safe Starting mysqld daemon with databases from /data/mysq
[root@localhost mysql]# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.25 MySQL Community Server (GPL)

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 

mysql> flush privileges;
mysql>  alter user root@'localhost' identified by '123456';

#--skip-grant-tables  跳过验证
#--skip-networking 跳过TCP连接验证
[root@db01 ~]# pkill mysqld
[root@db01 ~]# systemctl start  mysqld
```



## 2.3：初始化配置:

### 2.3.1:初始配置文件:

```bash
[root@db01 ~]# mysqld --help --verbose |grep my.cnf
/etc/my.cnf /etc/mysql/my.cnf /usr/local/mysql/etc/my.cnf ~/.my.cnf
注:
默认情况下，MySQL启动时，会依次读取以上配置文件，如果有重复选项，会以最后一个文件设置的为准。
但是，如果启动时加入了--defaults-file=xxxx时，以上的所有文件都不会读取.
```



### 2.3.2：配置文件的书写方式:

```bash
[标签]
配置项=xxxx

标签类型：服务端、客户端
服务器端标签：
[mysqld]
[mysqld_safe]
[server]

客户端标签：
[mysql]
[mysqldump]
[client]

配置文件的示例展示：
[root@db01 ~]# cat /etc/my.cnf
[mysqld]
user=mysql #启动用户
basedir=/app/mysql #程序目录
datadir=/data/mysql #mysql数据存放路径
socket=/data/mysql.sock #套接字文件路径
log_error=/data/mysql.log #错误日志路径
server_id=6
port=3306
log_error=/data/mysql/mysql.log
[mysql]
socket=/tmp/mysql.sock
prompt=Master [\\d]>
```



### 2.3.4：准备配置文件:

```bash
cat > /data/3307/my.cnf <<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3307/data
socket=/data/3307/mysql.sock
log_error=/data/3307/mysql.log
port=3307
server_id=7
log_bin=/data/3307/mysql-bin
EOF

cat > /data/3308/my.cnf <<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3308/data
socket=/data/3308/mysql.sock
log_error=/data/3308/mysql.log
port=3308
server_id=8
log_bin=/data/3308/mysql-bin
EOF

cat > /data/3309/my.cnf <<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3309/data
socket=/data/3309/mysql.sock
log_error=/data/3309/mysql.log
port=3309
server_id=9
log_bin=/data/3309/mysql-bin
EOF
```



# 三：SQL基础应用:

* DDL
* DML
* DQL
* DCL
* SQL通用语法

## 3.1：SQL:

* SQL通用语法
  * SQL语句可以单行或多行书写，以分号结尾
  * SQL语句可以使用空格/缩进来增强语句的可读性
  * MySQL数据库的SQL语句不区分大小写，关键子建议使用大写
  * 注释
    * 单行注释: --注释内容或#注释内容(MySQL特有)
    * 多行注释: /*  注释内容*/



### 3.1.1: SQL分类:

| 分类 | 全程                       | 说明                                                   |
| ---- | -------------------------- | ------------------------------------------------------ |
| DDL  | Data Definition Language   | 数据定义语言，用来定义数据库对象（数据库，表，字段）   |
| DML  | Data Manipulation Language | 数据操作语言，用来对数据库表中的数据进行增删改查       |
| DQL  | Data Query Language        | 数据查询预言，用来查询数据库中表的记录                 |
| DCL  | Data Control Language      | 数据控制语言，用来创建数据库用户、控制数据库的访问权限 |



#### 3.1.1.1：数值类型:

| 分类     | 类型         | 大小   | 有符号(SINGEN)范围                                   | 无符号(SINGEN)范围                                    | 描述                 |
| -------- | ------------ | ------ | ---------------------------------------------------- | ----------------------------------------------------- | -------------------- |
| 数值类型 | TINYINT      | 1byte  | (-128,127)                                           | (0，255)                                              | 小整数值             |
| 数值类型 | SMALLINT     | 2bytes | (-32768,32767)                                       | （0，65535）                                          | 大整数值             |
| 数值类型 | MEDIUMINT    | 3bytes | (-8388608,8388607)                                   | (0，16777215)                                         | 大整数值             |
| 数值类型 | INT或INTEGER | 4bytes | (-2147483648,2147483647)                             | (0，4294967295)                                       | 大整数值             |
| 数值类型 | BIGINT       | 8bytes | (-2^63,2^63-1)                                       | (0，2^64-1)                                           | 极大整数值           |
| 数值类型 | FLOAT        | 4bytes | (-3.502823466vE+38. 3.402823466351 E+38)             | 0和(1.175494351 E-38,.3.402823466 E+38)               | 单精度浮点数值       |
| 数值类型 | DOUBLE       | 8bytes | (-1.7976931348623157 E+308,1.7976931348623157 E+308) | 0和(2.225073850721014 E-308,1.7976931348623157 E+308) | 双精度浮点数值       |
| 数值类型 | DECTMAL      |        | 依赖于M（精度）和D（标度）的值                       | 依赖于M（精度）和D（标度）的值                        | 小数值（精确定点数） |



#### 3.1.1.2: 字符串类型:

| 分类       | 类型       | 大小                  | 描述                         |
| ---------- | ---------- | --------------------- | ---------------------------- |
| 字符串类型 | CHAR       | 0-255 bytes           | 定义字符串                   |
| 字符串类型 | VARCHAR    | 0-65535 bytes         | 变长字符串                   |
| 字符串类型 | TINYBLOB   | 0-255 bytes           | 不超过255个字符的二进制数据  |
| 字符串类型 | TINYTEXT   | 0-255 bytes           | 短文本字符串                 |
| 字符串类型 | BLOB       | 0-65 535bytes         | 二进制形式的文本数据         |
| 字符串类型 | TEXT       | 0-65 535 bytes        | 长文本数据                   |
| 字符串类型 | MEDLUMBLOB | 0-16 777 215 bytes    | 二进制形式的中等长度文本数据 |
| 字符串类型 | MEDIUMTEXT | 0-16 777 215 bytes    | 中等长度文本数据             |
| 字符串类型 | LONGBLOB   | 0-4 294 967 295 bytes | 二进制形式的极大文本数据     |
| 字符串类型 | LONGTEXT   | 0-4 294 967 295 bytes | 极大文本数据                 |





#### 3.1.1.3: 时间类型:

| 分类     | 类型      | 范围                                      | 大小 | 格式                | 描述                     |
| -------- | --------- | ----------------------------------------- | ---- | ------------------- | ------------------------ |
| 日期类型 | DATE      | 1000-01-01至9999-12-31                    | 3    | YYYY-MM-DD          | 日期值                   |
| 日期类型 | TIME      | -838：59:59至838：59：59                  | 3    | HH:MM:SS            | 时间值或持续时间         |
| 日期类型 | YEAR      | 1901至2155                                | 1    | YYYY                | 年份值                   |
| 日期类型 | DATETIME  | 1000-01-01 00:00:00 至9999-21-31 23:59:59 | 8    | YYYY-MM-DD HH:MM:SS | 混合日期和时间值         |
| 日期类型 | TIMESTAMP | 1970-01-01 00:00:00 至2038-01-19 03:14:07 | 4    | YYYY-MM-DD HH:MM:SS | 混合日期和时间值，时间戳 |





#### 3.1.1.4：字符集:

```bash
utf8       
utf8mb4
```



## 3.2: 表属性:

### 3.2.1: 列属性:

```bash
约束(一般建表时添加):
**primary key** ：主键约束
设置为主键的列，此列的值必须非空且唯一，主键在一个表中只能有一个，但是可以有多个列一起构成。
**not null**      ：非空约束
列值不能为空，也是表设计的规范，尽可能将所有的列设置为非空。可以设置默认值为0
**unique key** ：唯一键
列值不能重复
**unsigned** ：无符号
针对数字列，非负数。

其他属性:
**key** :索引
可以在某列上建立索引，来优化查询,一般是根据需要后添加
**default**           :默认值
列中，没有录入值时，会自动使用default的值填充
**auto_increment**:自增长
针对数字列，顺序的自动填充数据（默认是从1开始，将来可以设定起始点和偏移量）
**comment ** : 注释
```



### 3.2.2：表属性：

```bash
存储引擎:
InnoDB（默认的）
字符集和排序规则:
utf8       
utf8mb4
```



## 3.3：DDL语句:

### 3.3.1: 创建数据库:

```bash
查询
查询所有数据库
#SHOW DATABASES；
查询当前数据库
#SELECT DATABASE();

创建
#CREATE DATABASE [ IF NOT EXISTS 可选]数据库名[DEFAULT CHARSET 可选字符集] [COLLATE 可选 排序规则];

#创建utf8数据库
create database test  charset utf8;

#创建数据库设置字符集
mysql> create database itheima default charset utf8mb4;
Query OK, 1 row affected (0.00 sec)

如果数据库不存在就创建，存在就不创建
#create database if not exists itcast;
Query OK, 1 row affected, 1 warning (0.00 sec)

#删除数据库
mysql> drop database itcast;
#删除
DROP DATABASE [IF EXSISTS] 数据库名；

#列出所有字符集
show COLLATION;
mysql> show charset;

#查询数据库创建的语句
show create database test;

建库规范：
1.库名不能有大写字母   
2.建库要加字符集         
3.库名不能有数字开头
4. 库名要和业务相关
切换数据库
USE 数据库名
```



### 3.3.2: 表的定义:

```bash
#表操作-创建
mysql>CREATE TABLE 表明(
字段1 字段1类型[COMMENT 字段1注释]，
字段2 字段2类型[COMMENT 字段2注释]，
字段3 字段2类型[COMMENT 字段3注释]
)[COMMENT 表注释];

mysql>  CREATE TABLE stu(
 id      INT NOT NULL PRIMARY KEY AUTO_INCREMENT COMMENT '学号',
 name    VARCHAR(255) NOT NULL COMMENT '姓名',
 sage     TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '年龄',
 sgender  ENUM('m','f','n') NOT NULL DEFAULT 'n' COMMENT '性别',
 sfz     CHAR(18) NOT NULL UNIQUE COMMENT '身份证',
 time    TIMESTAMP NOT NULL DEFAULT NOW()  COMMENT '入学时间'
 ) ENGINE=INNODB CHARSET=utf8 COMMENT '学生表';

mysql> create table tb_user(
    -> id int comment '编号',
    -> name varchar(50) comment '姓名',
    -> age int comment '年龄',
    -> gender varchar(1) comment '性别'
    -> ) comment '用户表';
Query OK, 0 rows affected (0.02 sec)

mysql> show tables;
+------------------+
| Tables_in_itcast |
+------------------+
| tb_user          |
+------------------+
1 row in set (0.00 sec)

mysql> desc tb_user;
+--------+-------------+------+-----+---------+-------+
| Field  | Type        | Null | Key | Default | Extra |
+--------+-------------+------+-----+---------+-------+
| id     | int(11)     | YES  |     | NULL    |       |
| name   | varchar(50) | YES  |     | NULL    |       |
| age    | int(11)     | YES  |     | NULL    |       |
| gender | varchar(1)  | YES  |     | NULL    |       |
+--------+-------------+------+-----+---------+-------+
4 rows in set (0.00 sec)

mysql> show create table tb_user;
+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table   | Create Table                                                                                                                                                                                                                                                                           |
+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| tb_user | CREATE TABLE `tb_user` (
  `id` int(11) DEFAULT NULL COMMENT '编号',
  `name` varchar(50) DEFAULT NULL COMMENT '姓名',
  `age` int(11) DEFAULT NULL COMMENT '年龄',
  `gender` varchar(1) DEFAULT NULL COMMENT '性别'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户表'            |
+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)


#查询当前数据库所有表
mysql> show tables;

#查询表结构
mysql>DESC 表名；

#查询指定表的建表语句
SHOW CREATE TABLE 表明；


1. 表名小写
2. 不能是数字开头
3. 注意字符集和存储引擎
4. 表名和业务有关
5. 选择合适的数据类型
6. 每个列都要有注释
7. 每个列设置为非空，无法保证非空，用0来填充。
```



### 3.3.3: 表的修改：

```bash
#在stu表中添加qq列
ALTER TABLE stu ADD qq VARCHAR(20) NOT NULL UNIQUE COMMENT 'qq号'

#在name后加微信列
ALTER TABLE stu ADD wechar VARCHAR(64) NOT NULL UNIQUE  COMMENT '微信号'AFTER name;
#在id列前加一个新列num
ALTER TABLE stu ADD num INT NOT NULL   COMMENT '数字' FIRST;

#把刚才的列都删掉
ALTER TABLE stu DROP num;

#修改name数据类型的属性
ALTER TABLE stu MODIFY name VARCHAR(128) NOT NULL;

#修改数据类型
ALTER TABLE 表明 MODIFY 字段名 新数据类型(长度);

#修改字段名和字段类型
ALTER TABLE 表名 CHANGE 旧字段名 新字段名 类型（长度） [comment 注释] [约束];

#案例：
将emp表的nickname字段修改为username，类型为varchar(30)

mysql> alter table emp change nickname username varchar(30) comment '用户名';

#删除字段
ALTER TABLE 表明 DROP 字段名

#案例
将emp表的字段username删除

mysql> alter table emp drop username;

#修改表明
ALTER TABLE 表名 RENAME TO 新表名；

#删除表
DROP TABLE [IF EXISTS ] 表名

#删除指定表，并重新创建该表，表中的数据会被清理
TRUNCATE TABLE 表名；
#创建ceshi表复制stu表结构数据
CREATE TABLE ceshi LIKE stu;
```



### 3.3.4：案例:

设计一长员工信息表,要求如下:

```bash
1.编号(数字)
2.员工共给（字符串类型，长度不超过10位）
3.员工姓名（字符串类型，长读不超过10位）
4.性别（男/女，存储一个汉字）
5.年龄（正常人年龄，不可能存储负数）
6.身份证号（二代身份证员均为18位，身份证）
7.入职时间（取值年月日即可）


mysql> create table emp (
    -> id int comment '编号',
    -> workno varchar(10) comment '工号',
    -> name varchar(10) comment '姓名',
    -> gender char(1) comment '性别',
    -> age tinyint unsigned comment '年龄',
    -> idcard char(18) comment '身份证号',
    -> entrydate date comment '入职时间'
    -> ) comment '员工表';
Query OK, 0 rows affected (0.03 sec)

mysql> show tables;
+------------------+
| Tables_in_itcast |
+------------------+
| emp              |
| tb_user          |
+------------------+
2 rows in set (0.00 sec)

mysql> desc emp;
+-----------+---------------------+------+-----+---------+-------+
| Field     | Type                | Null | Key | Default | Extra |
+-----------+---------------------+------+-----+---------+-------+
| id        | int(11)             | YES  |     | NULL    |       |
| workno    | varchar(10)         | YES  |     | NULL    |       |
| name      | varchar(10)         | YES  |     | NULL    |       |
| gender    | char(1)             | YES  |     | NULL    |       |
| age       | tinyint(3) unsigned | YES  |     | NULL    |       |
| idcard    | char(18)            | YES  |     | NULL    |       |
| entrydate | date                | YES  |     | NULL    |       |
+-----------+---------------------+------+-----+---------+-------+
7 rows in set (0.00 sec)


mysql> show create table emp;

| emp   | CREATE TABLE `emp` (
  `id` int(11) DEFAULT NULL COMMENT '编号',
  `workno` varchar(10) DEFAULT NULL COMMENT '工号',
  `name` varchar(10) DEFAULT NULL COMMENT '姓名',
  `gender` char(1) DEFAULT NULL COMMENT '性别',
  `age` tinyint(3) unsigned DEFAULT NULL COMMENT '年龄',
  `idcard` char(18) DEFAULT NULL COMMENT '身份证号',
  `entrydate` date DEFAULT NULL COMMENT '入职时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='员工表'                      |

1 row in set (0.00 sec)

```





## 3.4： DML语句:

* DML英文全称是Data Manipulation Language(数据操作语言)，用来对数据库表中的数据记录进行增删改操作

* 添加数据(INSERT)
* 修改数据（UPDATE）
* 删除数据（DELETE）

### 3.4.1：DML-添加数据：

1. 给指定字段添加数据

   ```bash
   INSERT INTO 表明(字段1,字段2) VALUES（值1，值2....）;
   
   #给全部字段添加数据
   INSERT INTO 表名 VALUES(值1，值2);
   #批量添加数据
   INSERT INTO 表明(字段1,字段2) VALUES（值1，值2....），（值1，值2），（值1，值2）;
   INSERT INTO 表明  VALUES（值1，值2....），（值1，值2）;
   
   INSERT INTO employee(id, workno, name, gender, age, idcard, entrydate) VALUES (1, 1, 'tact', '男', 10, '123456789012345678', '2000-09-09');
   
   mysql> select * from employee;
   +------+--------+------+--------+------+--------------------+------------+
   | id   | workno | name | gender | age  | idcard             | entrydate  |
   +------+--------+------+--------+------+--------------------+------------+
   |    1 | 1      | tact | 男     |   10 | 123456789012345678 | 2000-09-09 |
   +------+--------+------+--------+------+--------------------+------------+
   
   
   INSERT INTO employee  VALUES (2, 2, 'tact1', '男', 11, '123456789012345678', '2001-09-09');
   
   mysql> select * from employee;
   +------+--------+-------+--------+------+--------------------+------------+
   | id   | workno | name  | gender | age  | idcard             | entrydate  |
   +------+--------+-------+--------+------+--------------------+------------+
   |    1 | 1      | tact  | 男     |   10 | 123456789012345678 | 2000-09-09 |
   |    2 | 2      | tact1 | 男     |   11 | 123456789012345678 | 2001-09-09 |
   +------+--------+-------+--------+------+--------------------+------------+
   
   
   
   INSERT INTO employee  VALUES (3, 3, 'tact2', '男', 12, '123456789012345678', '2002-09-09'),(4, 4, 'tact3', '男', 13, '123456789012345678', '2002-09-09');
   
   
   mysql> select * from employee;
   +------+--------+-------+--------+------+--------------------+------------+
   | id   | workno | name  | gender | age  | idcard             | entrydate  |
   +------+--------+-------+--------+------+--------------------+------------+
   |    1 | 1      | tact  | 男     |   10 | 123456789012345678 | 2000-09-09 |
   |    2 | 2      | tact1 | 男     |   11 | 123456789012345678 | 2001-09-09 |
   |    3 | 3      | tact2 | 男     |   12 | 123456789012345678 | 2002-09-09 |
   |    4 | 4      | tact3 | 男     |   13 | 123456789012345678 | 2002-09-09 |
   +------+--------+-------+--------+------+--------------------+------------+
   
   ```

   

### 3.4.2: DML-修改数据:

```bash
UPDATE 表明 SET 字段名=值1，字段2=值2,....[where 条件]
#更改条件1的名字
update employee set name='itheima' where id =1;

mysql> select * from employee;
+------+--------+---------+--------+------+--------------------+------------+
| id   | workno | name    | gender | age  | idcard             | entrydate  |
+------+--------+---------+--------+------+--------------------+------------+
|    1 | 1      | itheima | 男     |   10 | 123456789012345678 | 2000-09-09 |



mysql> select * from employee;
+------+--------+--------+--------+------+--------------------+------------+
| id   | workno | name   | gender | age  | idcard             | entrydate  |
+------+--------+--------+--------+------+--------------------+------------+
|    1 | 1      | 小昭   | 女     |   10 | 123456789012345678 | 2000-09-09 |

#更改条件1的名称
update employee set name='小昭' ,gender = '女' where id =1;



mysql> select * from employee;
+------+--------+--------+--------+------+--------------------+------------+
| id   | workno | name   | gender | age  | idcard             | entrydate  |
+------+--------+--------+--------+------+--------------------+------------+
|    1 | 1      | 小昭   | 女     |   10 | 123456789012345678 | 2000-09-09 |

#更改表中所有的日志时间
update employee set entrydate='2023-09-09';

mysql> select * from employee;
+------+--------+--------+--------+------+--------------------+------------+
| id   | workno | name   | gender | age  | idcard             | entrydate  |
+------+--------+--------+--------+------+--------------------+------------+
|    1 | 1      | 小昭   | 女     |   10 | 123456789012345678 | 2023-09-09 |
|    2 | 2      | tact1  | 男     |   11 | 123456789012345678 | 2023-09-09 |
|    3 | 3      | tact2  | 男     |   12 | 123456789012345678 | 2023-09-09 |
|    4 | 4      | tact3  | 男     |   13 | 123456789012345678 | 2023-09-09 |
+------+--------+--------+--------+------+--------------------+------------+

```



### 3.4.3：DML-删除数据:

```bash
DELETE FROM 表明 [where 条件]

#删除条件为女的记录
delete from employee where gender = '女';

mysql> select * from employee;
+------+--------+-------+--------+------+--------------------+------------+
| id   | workno | name  | gender | age  | idcard             | entrydate  |
+------+--------+-------+--------+------+--------------------+------------+
|    2 | 2      | tact1 | 男     |   11 | 123456789012345678 | 2023-09-09 |
|    3 | 3      | tact2 | 男     |   12 | 123456789012345678 | 2023-09-09 |
|    4 | 4      | tact3 | 男     |   13 | 123456789012345678 | 2023-09-09 |
+------+--------+-------+--------+------+--------------------+------------+

#删除表中所有的数据
delete from employee;

select * from employee;
Empty set (0.00 sec)


#TRUNCATE 清空标段中的数据页释放空间
TRUNCATE TABLE stu;

DELETE FROM stu
truncate table stu;
区别:
delete: DML操作, 是逻辑性质删除,逐行进行删除,速度慢.
truncate: DDL操作,对与表段中的数据页进行清空,速度快.
```



## 3.5：DQL语句:

* DQL英文全称是Data Query Language(数据查询语言)，用来查询数据库中的记录
* SELECT (数据查询语句)



```bash
SELECT 
	字段列表
FROM 
	表明列表
WHERE
	条件列表
GROUP BY
	分组字段列表
HAVING
	分组后条件列表
ORDER BY
	排序字段列表
LIMIT
	分页参数
	
条件查询where
聚合函数 count max min avg sum
分组查询 GROUP BY
排序查询 ORDER BY
分页查询 LIMIT
```



### 3.5.1：DQL-基本查询:

```bash
#查询多个字段
SELECT 字段1，字段2...FROM 表明;
SELECT * FROM 表明；
#查看端口号
select @@port;
#查看数据目录
select @@basedir;
#查看程序目录
select @@datadir;
#查看socket目录位置
select @@socket;
#查看server_id
select @@server_id;
#查看错误日志位置
select @@log_error;
#查看当前时间
select NOW();
#查看当前用户
SELECT USER();



#设置别名
SELECT 字段1 [AS 别名1]，字段2[AS 别名2].... from 表名;

#去除重复记录
SELECT DISTINCT 字段列表 FROM 表名;



#环境准备


create table emp(
    id            int                 comment '编号',
    workno        varchar(10)         comment '工号',
    name          varchar(10)         comment '姓名',
    gender        char(1)             comment '性别',
    age           tinyint unsigned    comment '年龄',
    idcard        char(18)            comment '身份证号',
    workaddress   varchar(50)         comment '工作地址',
    entrydate     date               comment '入职时间'
) comment '员工表';

insert into emp (id,workno,name,gender,age,idcard,workaddress,entrydate)
values (1,'1','张三','女',20,'12345678012345678','北京','2000-01-01'),
      (2,'2','李四','男',18,'12345678012345677','北京','2005-02-01'),
      (3,'3','王三','男',37,'12345678012345676','上海','2005-08-01'),
      (4,'4','赵四','男',13,'12345678012345643','北京','2009-12-01'),
      (5,'5','小赵','女',16,'12345678012345622','上海','2007-07-01'),
      (6,'6','杨肖','男',28,'1234567801234522x','北京','2006-01-01'),
      (7,'7','韦一韦','女',20,'12345678012345613','北京','2006-01-01'),
      (8,'8','代其兄','女',38,'12345678012345631','天津','2015-05-01'),
      (9,'9','为凉凉','女',45,'12345678012345235','上海','2010-04-01'),
      (10,'10','陈友谅','男',53,'12345678012345431','江苏','2011-01-01'),
      (11,'11','张士诚','男',55,'12345678012345613','西安','2020-05-01'),
      (12,'12','灭绝','女',65,'12345678012345624','西安','2018-07-01'),
      (13,'13','周欺辱','女',18,'null','北京','2012-06-01');
      
      
#查询指定字段name,workno,age

mysql> select name,workno,age from emp;
+-----------+--------+------+
| name      | workno | age  |
+-----------+--------+------+
| 张三      | 1      |   20 |
| 李四      | 2      |   18 |
| 王三      | 3      |   37 |
| 赵四      | 4      |   13 |
| 小赵      | 5      |   16 |
| 杨肖      | 6      |   28 |
| 韦一韦    | 7      |   20 |
| 代其兄    | 8      |   38 |
| 为凉凉    | 9      |   45 |
| 陈友谅    | 10     |   53 |
| 张士诚    | 11     |   55 |
| 灭绝      | 12     |   65 |
| 周欺辱    | 13     |   18 |
+-----------+--------+------+
13 rows in set (0.00 sec)

#查询所有字段

mysql> select id,workno,name,gender,age,idcard,workaddress,entrydate from emp;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
13 rows in set (0.00 sec)

#查询所有员工的工作地址，起别名

mysql> select workaddress as '工作地址' from emp;
+--------------+
| 工作地址     |
+--------------+
| 北京         |
| 北京         |
| 上海         |
| 北京         |
| 上海         |
| 北京         |
| 北京         |
| 天津         |
| 上海         |
| 江苏         |
| 西安         |
| 西安         |
| 北京         |
+--------------+
13 rows in set (0.00 sec)

#查询公司员工的上班地址不要重复
mysql> select distinct workaddress as '工作地址' from emp;
+--------------+
| 工作地址     |
+--------------+
| 北京         |
| 上海         |
| 天津         |
| 江苏         |
| 西安         |
+--------------+

```



#### 3.5.1.1: 单表子句-where:

##### 3.5.1.1.1:  where配置等值查询:

```bash
----查询在北京城市的人名
select * from emp where workaddress='北京'

----查询名字是张三
select * from emp where name='张三'
```



##### 3.5.1.1.2: where配合比较操作符:

```bash
----查询年龄小于20
select * from emp where age < 20
```



##### 3.5.1.1.3: where配合逻辑运算符:

```bash
---查询年龄大于20小于40
select * from emp where age > 20 and age < 40;

---查询北京或者江苏

select * from emp where workaddress='北京' or workaddress='江苏'
```



##### 3.5.1.1.4: where配合in语句:

```bash
---查询北京或上海城市
select * from emp where workaddress IN ('北京','上海')
```



##### 3.5.1.1.5: where配合between and语句:

```bash
---查询年龄大于20 小于40
select * from emp where age  BETWEEN 20 AND  40;
```



##### 3.5.1.1.6：where配合模糊查询：

```bash
---查询城市名称后面带京的
select * from emp where workaddress LIKE '%京'

```





### 3.5.2: DQL-条件查询:

```bash
SELECT 字段列表 FROM 表名 WHERE 条件列表:
```



| 比较运算符       | 功能                                     | 逻辑运算符 | 功能                       |
| ---------------- | ---------------------------------------- | ---------- | -------------------------- |
| >                | 大于                                     | AND 或&&   | 并且（多个条件同时成立）   |
| >=               | 大于等于                                 | OR或\|\|   | 或者(多个条件任意一个成立) |
| <                | 小于                                     | NOT 或 ！  | 非,不是                    |
| <=               | 小于等于                                 |            |                            |
| =                | 等于                                     |            |                            |
| <>或!            | 不等于                                   |            |                            |
| BETWEEN...AND... | 在某个范围之内（含最小、最大）           |            |                            |
| LN(....)         | 在in之后的列表中的值，多选一             |            |                            |
| LIKE占位符       | 模糊匹配(_匹配单个字符，%匹配任意个字符) |            |                            |
| IS NULL          | 是NULL                                   |            |                            |



* 案例



```bash
#查询年龄等于88的员工
mysql> select * from emp where age = 88;

#查询年龄小于20的员工信息
mysql> select * from emp where age < 20;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+

#查询年龄小于等于20的员工信息
mysql> select * from emp where age <= 20;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
6 rows in set (0.00 sec)

#查询没有身份证号的员工信息
select * from emp idcard is null;

#查询有身份证号的员工信息 
select * from emp idcard is not null;
#查询年龄不等于88的员工信息
mysql> select * from emp where age != 88;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
13 rows in set (0.00 sec)

#查询年龄在15岁（包含）到20岁（包含）之间的员工信息

mysql> select * from emp where age >= 15 and age <=20;
mysql> select * from emp where age between 15 and age 20;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
5 rows in set (0.00 sec)

#查询性别为女且年龄小于25岁的员工信息
mysql> select * from emp where gender = '女' and age < 25;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+

#查询年龄等于18 或20 或40的员工信息
mysql> select * from emp where age in (18,20,40);
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+


#查询姓名为两个字的员工信息

mysql> select * from emp where name like '__';
+------+--------+--------+--------+------+-------------------+-------------+------------+
| id   | workno | name   | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+--------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三   | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四   | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    3 | 3      | 王三   | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    4 | 4      | 赵四   | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵   | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    6 | 6      | 杨肖   | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|   12 | 12     | 灭绝   | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   14 | 14     | 张五   | 女     |   88 | 12345678012345611 | 北京        | 2000-01-01 |
+------+--------+--------+--------+------+-------------------+-------------+------------+

#查询身份证后最后一位是X的员工信息
mysql> select * from emp where idcard like '%x';
+------+--------+--------+--------+------+-------------------+-------------+------------+
| id   | workno | name   | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+--------+--------+------+-------------------+-------------+------------+
|    6 | 6      | 杨肖   | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
+------+--------+--------+--------+------+-------------------+-------------+------------+

```



### 3.5.3：DQL-聚合函数:

* 将一列数据作为一个整体，进行纵向计算



| 函数  | 功能     |
| ----- | -------- |
| conut | 统计数量 |
| max   | 最大值   |
| min   | 最小值   |
| avg   | 平均值   |
| sum   | 求和     |



```bash
SELECT 聚合函数 FROM 表名
#null值不计算聚合函数里面
#案例
#统计改企业员工信息
mysql> select count(*) from emp;
#统计改企业员工的平均年龄
mysql> select avg(age) from emp;
+----------+
| avg(age) |
+----------+
|  35.2667 |
+----------+

#统计改企业员工的最大年龄
mysql> select max(age) from emp;
+----------+
| max(age) |
+----------+
|       88 |
+----------+
1 row in set (0.00 sec)

#统计改企业员工的最小年龄

mysql> select min(age) from emp;
+----------+
| min(age) |
+----------+
|       13 |
+----------+
1 row in set (0.00 sec)

#统计西安地区员工的年龄之后

mysql> select sum(age) from emp where workaddress='西安' ;
+----------+
| sum(age) |
+----------+
|      120 |
+----------+

```



#### 3.5.3.1：单表子句-group by：

```bash
---统计emp表每个城市的年龄总数
select workaddress,SUM(age)  FROM emp GROUP BY workaddress;

---统计北京城市年龄总数
select SUM(age)  FROM emp where workaddress='北京';

```



#### 3.5.3.2：单表子句-having：

```bash
---统计每个城市的年龄总和只打印小于100的年龄
select workaddress,SUM(age)  FROM emp GROUP BY workaddress 
HAVING SUM(age) < 100

注意:having条件是不走索引的
```



#### 3.5.3.3：单表子句-order by :

```bash
--查看城市信息，并按年龄数量从大到小排序
select workaddress from emp ORDER BY workaddress DESC;

```



#### 3.5.3.4： 单表子句-limit：

```bash
---统计中国,每个省的总人口,找出总人口大于500w的,并按总人口从大到小排序,只显示前三名
SELECT  district, SUM(population)  FROM  city 
WHERE countrycode='CHN'
GROUP BY district 
HAVING SUM(population)>5000000
ORDER BY SUM(population) DESC
LIMIT 3 ;

LIMIT N ,M --->跳过N,显示一共M行
LIMIT 5,5

SELECT  district, SUM(population)  FROM  city 
WHERE countrycode='CHN'
GROUP BY district 
HAVING SUM(population)>5000000
ORDER BY SUM(population) DESC
LIMIT 5,5;
```

### 3.5.6: DQL-联合查询-union all

```bash
-- 中国或美国城市信息

SELECT * FROM city 
WHERE countrycode IN ('CHN' ,'USA');

SELECT * FROM city WHERE countrycode='CHN'
UNION ALL
SELECT * FROM city WHERE countrycode='USA'

说明:一般情况下,我们会将 IN 或者 OR 语句 改写成 UNION ALL,来提高性能
UNION     去重复
UNION ALL 不去重复
```



### 3.5.7: DQL-多表查询:

```bash
#准备案例
CREATE TABLE student(
sno INT NOT NULL PRIMARY KEY AUTO_INCREMENT COMMENT '学号',
sname VARCHAR(20) NOT NULL COMMENT '姓名',
sage TINYINT UNSIGNED  NOT NULL COMMENT '年龄',
ssex  ENUM('f','m') NOT NULL DEFAULT 'm' COMMENT '性别'
)ENGINE=INNODB CHARSET=utf8;

CREATE TABLE course(
cno INT NOT NULL PRIMARY KEY COMMENT '课程编号',
cname VARCHAR(20) NOT NULL COMMENT '课程名字',
tno INT NOT NULL  COMMENT '教师编号'
)ENGINE=INNODB CHARSET utf8;

CREATE TABLE sc (
sno INT NOT NULL COMMENT '学号',
cno INT NOT NULL COMMENT '课程编号',
score INT  NOT NULL DEFAULT 0 COMMENT '成绩'
)ENGINE=INNODB CHARSET=utf8;

CREATE TABLE teacher(
tno INT NOT NULL PRIMARY KEY COMMENT '教师编号',
tname VARCHAR(20) NOT NULL COMMENT '教师名字'
)ENGINE=INNODB CHARSET utf8;

INSERT INTO student(sno,sname,sage,ssex)
VALUES (1,'zhang3',18,'m');

INSERT INTO student(sno,sname,sage,ssex)
VALUES
(2,'zhang4',18,'m'),
(3,'li4',18,'m'),
(4,'wang5',19,'f');

INSERT INTO student
VALUES
(5,'zh4',18,'m'),
(6,'zhao4',18,'m'),
(7,'ma6',19,'f');

INSERT INTO student(sname,sage,ssex)
VALUES
('oldboy',20,'m'),
('oldgirl',20,'f'),
('oldp',25,'m');


INSERT INTO teacher(tno,tname) VALUES
(101,'oldboy'),
(102,'hesw'),
(103,'oldguo');

DESC course;
INSERT INTO course(cno,cname,tno)
VALUES
(1001,'linux',101),
(1002,'python',102),
(1003,'mysql',103);

DESC sc;
INSERT INTO sc(sno,cno,score)
VALUES
(1,1001,80),
(1,1002,59),
(2,1002,90),
(2,1003,100),
(3,1001,99),
(3,1003,40),
(4,1001,79),
(4,1002,61),
(4,1003,99),
(5,1003,40),
(6,1001,89),
(6,1003,77),
(7,1001,67),
(7,1003,82),
(8,1001,70),
(9,1003,80),
(10,1003,96);

SELECT * FROM student;
SELECT * FROM teacher;
SELECT * FROM course;
SELECT * FROM sc;


---统计zhang3,学习了几门课
SELECT st.sname , COUNT(sc.cno)
FROM student AS st
JOIN
sc
ON st.sno=sc.sno
WHERE st.sname='zhang3'
----查询zhang3,学习的课程名称有哪些?
SELECT st.sname , GROUP_CONCAT(co.cname)
FROM student AS st
JOIN sc
ON st.sno=sc.sno
JOIN course AS co
ON sc.cno=co.cno
WHERE st.sname='zhang3'
----查询oldguo老师教的学生名.
SELECT te.tname ,GROUP_CONCAT(st.sname)
FROM student AS st
JOIN sc
ON st.sno=sc.sno
JOIN course AS co
ON sc.cno=co.cno
JOIN teacher AS te
ON co.tno=te.tno
WHERE te.tname='oldguo';


---查询oldguo所教课程的平均分数
SELECT te.tname,AVG(sc.score)
FROM teacher AS te
JOIN course AS co
ON te.tno=co.tno
JOIN sc
ON co.cno=sc.cno
WHERE te.tname='oldguo'

---每位老师所教课程的平均分,并按平均分排序
SELECT te.tname,AVG(sc.score)
FROM teacher AS te
JOIN course AS co
ON te.tno=co.tno
JOIN sc
ON co.cno=sc.cno
GROUP BY te.tname
ORDER BY AVG(sc.score) DESC ;

```





---别名

```bash
列别名,表别名
SELECT 
a.Name AS an ,
b.name AS bn ,
b.SurfaceArea AS bs,
a.Population AS bp
FROM city AS a  JOIN country AS b
ON a.CountryCode=b.Code
WHERE a.name ='shenyang';
```



### 3.5.8：DQL-分组查询:

```bash
SELECT 字段列表 FROM 表名 [WHERE 条件] GROUP BY 分组字段名 [HAVING 分组后过滤条件]

where于having区别
执行时机不同: where是分组进行过滤，不满足where条件，不参与分组，而having是分组之后对结果进行过滤
判断条件不同: where不能对聚合函数进行判断，而having可以


#案例
#根据性别分组，统计男性员工女性员工的数量
mysql> select gender,count(*) from emp group by gender;
+--------+----------+
| gender | count(*) |
+--------+----------+
| 女     |        9 |
| 男     |        6 |
+--------+----------+
2 rows in set (0.00 sec)

#根据性别分组，统计男性员工和女性员工的平均年龄
mysql> select gender,avg(age) from emp group by gender;
+--------+----------+
| gender | avg(age) |
+--------+----------+
| 女     |  36.1111 |
| 男     |  34.0000 |
+--------+----------+
2 rows in set (0.00 sec)

#查询年龄小于45的员工，并根据工作地址分组，获取员工数量大于3的工作地址
select workaddress,count(*) address_count from emp where age < 45 group by workaddress having address_count >=3;
mysql> select workaddress,count(*) address_count from emp where age < 45 group by workaddress having count(*) >=3;
+-------------+----------+
| workaddress | count(*) |
+-------------+----------+
| 北京        |        7 |
+-------------+----------+


执行顺序 where > 聚合函数 > having

```



### 3.5.9: DQL-排序查询:

```bash
SELECT 字段列表 FROM 表名 ORDER BY 字段1 排序方式1，字段2 排序方式2；

ASC 升序
DESC 降序

#案例
#根据年龄对公司的员工进行升序排序
mysql> select * from emp  order by age asc;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|   15 | 15     | 刘哈哈    | 女     |   15 | null              | 北京        | 2013-06-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   14 | 14     | 张五      | 女     |   88 | 12345678012345611 | 北京        | 2000-01-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+


#根据入职时间，对员工进行降序排序
mysql> select * from emp  order by entrydate asc;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|   14 | 14     | 张五      | 女     |   88 | 12345678012345611 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
|   15 | 15     | 刘哈哈    | 女     |   15 | null              | 北京        | 2013-06-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+

#根据年龄对公司的员工进行升序排序，年龄相同，在按照入职时间进行降序排序
mysql> select * from emp  order by age asc,entrydate desc ;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|   15 | 15     | 刘哈哈    | 女     |   15 | null              | 北京        | 2013-06-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   14 | 14     | 张五      | 女     |   88 | 12345678012345611 | 北京        | 2000-01-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
15 rows in set (0.00 sec)

如果多字段排序，当第一个字段值相同时，才会根据第二个字段进行排序
```



### 3.5.10：DQL-分页查询:

```bash
SELECT 字段列表 FROM 表名LIMIT 起始索引，查询记录数；

起始索引从0开始，起始索引=(查询页码-1)*每页每页显示记录数
分页查询是数据库的方式，不同的数据库有不同的实现，Mysql中是LIMIT
如果查询的是第一页数据，起始索引可以省略，之间简写limit 10


#案例
#在查询第一页员工数据，每页展示10条记录
mysql> select * from emp limit 0,10;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    2 | 2      | 李四      | 男     |   18 | 12345678012345677 | 北京        | 2005-02-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
|    4 | 4      | 赵四      | 男     |   13 | 12345678012345643 | 北京        | 2009-12-01 |
|    5 | 5      | 小赵      | 女     |   16 | 12345678012345622 | 上海        | 2007-07-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
|    8 | 8      | 代其兄    | 女     |   38 | 12345678012345631 | 天津        | 2015-05-01 |
|    9 | 9      | 为凉凉    | 女     |   45 | 12345678012345235 | 上海        | 2010-04-01 |
|   10 | 10     | 陈友谅    | 男     |   53 | 12345678012345431 | 江苏        | 2011-01-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+

#查询第2页员工数据，每页显示10条记录
mysql> select * from emp limit 10,10;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|   11 | 11     | 张士诚    | 男     |   55 | 12345678012345613 | 西安        | 2020-05-01 |
|   12 | 12     | 灭绝      | 女     |   65 | 12345678012345624 | 西安        | 2018-07-01 |
|   13 | 13     | 周欺辱    | 女     |   18 | null              | 北京        | 2012-06-01 |
|   14 | 14     | 张五      | 女     |   88 | 12345678012345611 | 北京        | 2000-01-01 |
|   15 | 15     | 刘哈哈    | 女     |   15 | null              | 北京        | 2013-06-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
5 rows in set (0.00 sec)

```



### 3.5.11: DQL语句-案例:

```bash
#查询年龄为20，21，22，23岁的女性员工信息
mysql> select * from emp where gender='女' and age between 20 and 23;
mysql> select * from emp where gender='女' and age in(20,21,22,23);
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|    1 | 1      | 张三      | 女     |   20 | 12345678012345678 | 北京        | 2000-01-01 |
|    7 | 7      | 韦一韦    | 女     |   20 | 12345678012345613 | 北京        | 2006-01-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
2 rows in set (0.00 sec)

#查询性别为男，并且年龄在20-40岁以内的姓名为三个字的员工
mysql> select * from emp where gender = '男' and age between 20 and 40 and name like '___';
+------+--------+-----------+--------+------+--------+-------------+------------+
| id   | workno | name      | gender | age  | idcard | workaddress | entrydate  |
+------+--------+-----------+--------+------+--------+-------------+------------+
|   16 | 16     | 哇哈哈    | 男     |   25 |        | 上海        | 2014-06-01 |
+------+--------+-----------+--------+------+--------+-------------+------------+

#统计员工表中，年龄小于60岁的，男性员工和女性员工的人数
mysql> select  gender,count(*) from emp  where age <=60 group by gender;
+--------+----------+
| gender | count(*) |
+--------+----------+
| 女     |        7 |
| 男     |        7 |
+--------+----------+

#查询所有年龄小于等于35岁员工的姓名和年龄，并对查询结果按照你升序排序，如果年龄相同按照入职时间降序
mysql> select name,age,entrydate from emp where age <= 35 order by age asc,entrydate desc;
+-----------+------+------------+
| name      | age  | entrydate  |
+-----------+------+------------+
| 赵四      |   13 | 2009-12-01 |
| 刘哈哈    |   15 | 2013-06-01 |
| 小赵      |   16 | 2007-07-01 |
| 周欺辱    |   18 | 2012-06-01 |
| 李四      |   18 | 2005-02-01 |
| 韦一韦    |   20 | 2006-01-01 |
| 张三      |   20 | 2000-01-01 |
| 哇哈哈    |   25 | 2014-06-01 |
| 杨肖      |   28 | 2006-01-01 |
+-----------+------+------------+


#查询性别为男，且年龄在20-40岁以内的前5个员工信息，对查询的结果按照年龄升序排序，年龄相同按入职时间升序排序

mysql> select * from emp where  gender='男'  and age between 20 and 40 order by age asc,entrydate asc limit 5;
+------+--------+-----------+--------+------+-------------------+-------------+------------+
| id   | workno | name      | gender | age  | idcard            | workaddress | entrydate  |
+------+--------+-----------+--------+------+-------------------+-------------+------------+
|   16 | 16     | 哇哈哈    | 男     |   25 |                   | 上海        | 2014-06-01 |
|    6 | 6      | 杨肖      | 男     |   28 | 1234567801234522x | 北京        | 2006-01-01 |
|    3 | 3      | 王三      | 男     |   37 | 12345678012345676 | 上海        | 2005-08-01 |
+------+--------+-----------+--------+------+-------------------+-------------+------------+

```



### 3.5.12: DQL-执行顺序:

```
SELECT  4 
	字段列表
FROM   1
	表明列表  
WHERE  2 
	条件列表
GROUP BY   3 
	分组字段列表
HAVING
	分组后条件列表
ORDER BY 5
	排序字段列表
LIMIT  6
	分页参数
```



## 3.6: DCL语句：

* DCL英文全称是Dara Control Language(数据库控制语言)，用来管理数据库、用户、控制数据库的访问权限;

### 3.6.1：DCL-管理用户



```bash
#查询用户
USE mysql;
SELECT * FROM user;

#创建用户
CREATE USER ’用户名‘@’主机名‘ IDENTIFIED BY ’密码‘;

#修改用户密码
ALTER USER ’用户名‘@’主机名‘ IDENTIFIED WITH mysql_native_password BY '新密码'

#删除用户
DROP USER ’用户名‘@'主机名'

#创建用户itcast 只能在当前主机localhost访问，密码123456
mysql> create user 'itcast'@'localhost' identified by '123456';

#创建用户heima,可以在任意主机访问数据库，密码123456
mysql> create user 'heima'@'%' identified by '123456';
#修改用户heima的访问密码为1234
alter user 'heima'@'%' identified with mysql_native_password by '1234';
#删除itcast@localhost用户
mysql> drop user 'itcast'@'localhost';
```



### 3.6.2: DCL-权限控制:

| 权限               | 说明                |
| ------------------ | ------------------- |
| ALL,ALL PRIVILEGES | 所有权限            |
| SELECT             | 查询数据            |
| INSERT             | 插入数据            |
| UPDATE             | 修改数据            |
| DELETE             | 删除数据            |
| ALTER              | 修改表              |
| DROP               | 删除数据库/表、试图 |
| CREATE             | 创建数据库/表       |



```bash
#查询权限
SHow GRANTS FOR ’用户名‘@’主机名‘
show grants for 'heima'@'%';

#授予权限
GRANT  权限列表 ON 数据.表名 TO ’用户名‘@’主机名‘；

grant all on itcast.* to 'heima'@'%';
#撤销权限
REVOKE 权限列表 ON 数据库名.表名 FROM ’用户名‘@’主机名‘
revoke all on itcast.* from 'heima'@'%';

多个权限之间，可以数据逗号分隔

```

## 3.7: show命令:

```bash
show  databases;                          #查看所有数据库
show tables;                                          #查看当前库的所有表
SHOW TABLES FROM                        #查看某个指定库下的表
show create database world                #查看建库语句
show create table world.city                #查看建表语句
show  grants for  root@'localhost'       #查看用户的权限信息
show  charset；                                   #查看字符集
show collation                                      #查看校对规则
show processlist;                                  #查看数据库连接情况
show index from                                 #表的索引情况
show status                                         #数据库状态查看
SHOW STATUS LIKE '%lock%';         #模糊查询数据库某些状态
SHOW VARIABLES                             #查看所有配置信息
SHOW variables LIKE '%lock%';          #查看部分配置信息
show engines                                       #查看支持的所有的存储引擎
show engine innodb status\G               #查看InnoDB引擎相关的状态信息
show binary logs                                    #列举所有的二进制日志
show master status                                 #查看数据库的日志位置信息
show binlog evnets in                             #查看二进制日志事件
show slave status \G                             #查看从库状态
SHOW RELAYLOG EVENTS               #查看从库relaylog事件信息
desc  (show colums from city)               #查看表的列定义信息
http://dev.mysql.com/doc/refman/5.7/en/show.html
```



# 4: 函数:

## 4.1: 函数分类:

* 函数是指一段可以直接被另一段程序调用的程序或代码
* 函数分类
  * 字符串函数
  * 数值函数
  * 日志函数
  * 流程函数



### 4.1.1： 字符串函数:

* MysQL中内置了很多字符串函数，常用的几个如下



| 函数                     | 功能                                                  |
| ------------------------ | ----------------------------------------------------- |
| CONCAT(S1,S2，...sn)     | 字符串拼接，将S1,S2...SN拼接成一个字符串              |
| LOWER(STR)               | 将字符串str全部转为小写                               |
| UPPER（str）             | 将字符串str全部转为大写                               |
| LPAD（str,n,pad）        | 左填充，用字符串pad对str的左边进行填充，达到n个字符串 |
| RPAD(str,n,pad)          | 右填充，用字符串pad对str的右边进行填充，达到n个字符串 |
| TRIM(str)                | 去掉字符串头部和尾部的空格                            |
| SUBTREING(str,start,len) | 返回从字符串str从start位置起的len个长度的字符串       |



```bash
---concat
mysql> select concat('Hello','Mysql');
+-------------------------+
| concat('Hello','Mysql') |
+-------------------------+
| HelloMysql              |
+-------------------------+
---lower

mysql> select lower('Hello');
+----------------+
| lower('Hello') |
+----------------+
| hello          |
+----------------+


---upper
mysql> select upper('Hello');
+----------------+
| upper('Hello') |
+----------------+
| HELLO          |
+----------------+

---lpad
mysql> select lpad('01', 5, '-');
+--------------------+
| lpad('01', 5, '-') |
+--------------------+
| ---01              |
+--------------------+

---rpad
mysql> select rpad('01', 5, '-');
+--------------------+
| rpad('01', 5, '-') |
+--------------------+
| 01---              |
+--------------------+

---trim
mysql> select trim(' Hello  MySQL ');
+------------------------+
| trim(' Hello  MySQL ') |
+------------------------+
| Hello  MySQL           |
+------------------------+


--substring
mysql> select substring('Hello  MySQL',1,5);
+-------------------------------+
| substring('Hello  MySQL',1,5) |
+-------------------------------+
| Hello                         |
+-------------------------------+


#案例
#由于业务需求变更，改企业员工的工号，统一为5位数，目前不足5位数的全部在前面步0，比如：1号员工的工号应该为00001

mysql> update emp set workno = lpad(workno,5,'0')
```



### 4.1.2： 数值函数:



| 函数        | 说明                             |
| ----------- | -------------------------------- |
| CEIK(X)     | 向上取整                         |
| FLOOR(X)    | 向下取整                         |
| MOD（x，y） | 返回x/y的模                      |
| RAND（）    | 返回0~1的随机数                  |
| ROUND(x,y)  | 求参数x的四舍五入的值，保留y小数 |



```bash
---ceil
mysql> select ceil(1.5);
+-----------+
| ceil(1.5) |
+-----------+
|         2 |
+-----------+

--floor
mysql> select floor(1.1);
+------------+
| floor(1.1) |
+------------+
|          1 |
+------------+

--mod
mysql> select mod(3,4);
+----------+
| mod(3,4) |
+----------+
|        3 |
+----------+

--rand
mysql> select rand();
+---------------------+
| rand()              |
+---------------------+
| 0.22268606091168341 |
+---------------------+

--round
mysql> select round(2.34,2);
+---------------+
| round(2.34,2) |
+---------------+
|          2.34 |
+---------------+

#案例
#通过书库的函数，生成一个六位数的随机验证码
mysql> select lpad(round(rand()*1000000,0), 6,'0');
+--------------------------------------+
| lpad(round(rand()*1000000,0), 6,'0') |
+--------------------------------------+
| 889428                               |
+--------------------------------------+

```



### 4.1.3： 日期函数:



| 函数                              | 功能                                              |
| --------------------------------- | ------------------------------------------------- |
| CURDATE()                         | 返回当前日期                                      |
| CURTIME()                         | 返回当前时间                                      |
| NOW()                             | 返回当前日期和时间                                |
| YEAD(date)                        | 获取指定date的年份                                |
| MONTH(date)                       | 获取指定date的月份                                |
| DAY(date)                         | 获取指定date的日期                                |
| DATE_ADD(date,INTERVAL expr type) | 返回一个日期/时间值加上一个时间间隔expr后的时间值 |
| DATEDIFF(date1,date2）            | 返回起始时间和结束时间date之间的天数              |



```bash
---curdate()
mysql> select curdate();
+------------+
| curdate()  |
+------------+
| 2023-09-10 |
+------------+

---curtime()
mysql> select curtime();
+-----------+
| curtime() |
+-----------+
| 13:27:40  |
+-----------+
1 row in set (0.00 sec)

--now()
mysql> select now();
+---------------------+
| now()               |
+---------------------+
| 2023-09-10 13:27:55 |
+---------------------+

---YEAR, HONTH DAY

mysql> select YEAR(now());
+-------------+
| YEAR(now()) |
+-------------+
|        2023 |
+-------------+

mysql> select MONTH(now());
+--------------+
| MONTH(now()) |
+--------------+
|            9 |
+--------------+

mysql> select DAY(now());
+------------+
| DAY(now()) |
+------------+
|         10 |
+------------+

--date_add
mysql> select date_add(now(), INTERVAL 70 DAY);
+----------------------------------+
| date_add(now(), INTERVAL 70 DAY) |
+----------------------------------+
| 2023-11-19 13:29:43              |
+----------------------------------+
1 row in set (0.00 sec)

mysql> select date_add(now(), INTERVAL 70 YEAR);
+-----------------------------------+
| date_add(now(), INTERVAL 70 YEAR) |
+-----------------------------------+
| 2093-09-10 13:30:02               |
+-----------------------------------+

---datediff

mysql> select datediff('2021-12-01','2021-11-11');
+-------------------------------------+
| datediff('2021-12-01','2021-11-11') |
+-------------------------------------+
|                                  20 |
+-------------------------------------+

#案例
#查询所有员工的入职天数，并根据入职天数倒序排序

mysql> select name,datediff(curdate(),entrydate) as 'entrydays' from emp order by entrydays desc;
+-----------+-----------+
| name      | entrydays |
+-----------+-----------+
| 张三      |      8653 |
| 张五      |      8653 |
| 李四      |      6795 |
| 王三      |      6614 |
| 杨肖      |      6461 |
| 韦一韦    |      6461 |
| 小赵      |      5915 |
| 赵四      |      5031 |
| 为凉凉    |      4910 |
| 陈友谅    |      4635 |
| 周欺辱    |      4118 |
| 刘哈哈    |      3753 |
| 哇哈哈    |      3388 |
| 代其兄    |      3054 |
| 灭绝      |      1897 |
| 张士诚    |      1227 |
+-----------+-----------+

```



### 4.1.4：流程函数:

* 流程函数页是很常用的一类函数，可以在SQL语句中实现条件筛选，从而提高语句的效率



| 函数                                                   | 功能                                                       |
| ------------------------------------------------------ | ---------------------------------------------------------- |
| IF(value,t,f)                                          | 如果value为true，则返回t，否则返回                         |
| IFNULL(value1,value2)                                  | 如果value不为空，返回value1，否则返回value2                |
| CASE WHEN [val1] THEN [res1]...ELSE[default]END        | 如果val1为true，返回res1，...否则返回default默认值         |
| CASE[expr] WHEN [val1] THEN [resl] ...ELSE[default]END | 如果expr的值等于val1，返回resl,。。。否则返回default默认值 |



```bash
---IF
mysql> select if(true,'ok','error');
+-----------------------+
| if(true,'ok','error') |
+-----------------------+
| ok                    |
+-----------------------+
1 row in set (0.00 sec)

---IFNULL
mysql> select ifnull('ok','default');
+------------------------+
| ifnull('ok','default') |
+------------------------+
| ok                     |
+------------------------+

---CASE when then else end
mysql> select name,case workaddress when '北京' then '一线城市' when '上海' then '一线城市' else '二线城市' end as '工作地址' from emp;
+-----------+--------------+
| name      | 工作地址     |
+-----------+--------------+
| 张三      | 一线城市     |
| 李四      | 一线城市     |
| 王三      | 一线城市     |
| 赵四      | 一线城市     |
| 小赵      | 一线城市     |
| 杨肖      | 一线城市     |
| 韦一韦    | 一线城市     |
| 代其兄    | 二线城市     |
| 为凉凉    | 一线城市     |
| 陈友谅    | 二线城市     |
| 张士诚    | 二线城市     |
| 灭绝      | 二线城市     |
| 周欺辱    | 一线城市     |
| 张五      | 一线城市     |
| 刘哈哈    | 一线城市     |
| 哇哈哈    | 一线城市     |
+-----------+--------------+


```



## 4.2： 约束：

* 约束是u总用于表中字段上的规则，用于限制存储在表中的数据
* 保证数据库中的正确，有效和完整型
* 分类

| 约束     | 描述                                                     | 关键字      |
| -------- | -------------------------------------------------------- | ----------- |
| 非空约束 | 限制该字段的数据步能为null                               | NOT NULL    |
| 唯一约束 | 保证该字段的所有数据都是唯一、不重复的                   | UNIQUE      |
| 主键约束 | 主键是一行数据的唯一标识，要求非空且唯一                 | PRIMARY KEY |
| 默认约束 | 保存数据时，如果未指定改字段的值，则采用默认值           | DEFAULT     |
| 检查约束 | 保证字段值满足某一个条件                                 | CHECK       |
| 外键约束 | 用来让两张表的数据之间建立连接，保证数据的一致性和完整型 | FOREIGN KEY |



### 4.2.1：约束演示:

| 字段名 | 字段含义   | 字段类型    | 约束条件                  | 约束关键字                  |
| ------ | ---------- | ----------- | ------------------------- | --------------------------- |
| id     | ID唯一标识 | int         | 主键，并且自动增长        | PRIMARY KEY ,AUTO_INCREMENT |
| name   | 姓名       | varvhar(10) | 不为空，并且唯一          | NOT NULL,UNQUE              |
| age    | 年龄       | int         | 大于0，并且小于等于120    | CHECK                       |
| status | 状态       | char(1)     | 如果没有指定改值，默认为1 | DEFAULT                     |
| gender | 性别       | char(1)     | 无                        |                             |



```sql
---
create table user(
    id int primary key auto_increment comment '主键',
    name varchar(10) not null unique comment '姓名',
    age int check ( age > 0 && age <= 120 ) comment '年龄',
    status char(1) default '1' comment '状态',
    gender char(1) comment '性别'
) comment '用户表';

mysql> desc user;
+--------+-------------+------+-----+---------+----------------+
| Field  | Type        | Null | Key | Default | Extra          |
+--------+-------------+------+-----+---------+----------------+
| id     | int(11)     | NO   | PRI | NULL    | auto_increment |
| name   | varchar(10) | NO   | UNI | NULL    |                |
| age    | int(11)     | YES  |     | NULL    |                |
| status | char(1)     | YES  |     | 1       |                |
| gender | char(1)     | YES  |     | NULL    |                |
+--------+-------------+------+-----+---------+----------------+


insert into user(name,age,status,gender) values('tom',19,'1','男'),('tom1',20,'0','男');

mysql> select * from user;
+----+------+------+--------+--------+
| id | name | age  | status | gender |
+----+------+------+--------+--------+
|  1 | tom  |   19 | 1      | 男     |
|  2 | tom1 |   20 | 0      | 男     |
+----+------+------+--------+--------+
---名称不允许非空
mysql> insert into user(name,age,status,gender) values(null,20,'3','男');
ERROR 1048 (23000): Column 'name' cannot be nul

---名称不允许重复
mysql> insert into user(name,age,status,gender) values('tom2',20,'3','男');
ERROR 1062 (23000): Duplicate entry 'tom2' for key 'name'
```



### 4.2.2： 外键约束:

* 外键用来让两张表的数据之间建立连接，从而保证数据的一致性和完整型



# 五：存储引擎:

## 5.1: 引擎种类查看:

```bash
show engines;
存储引擎是作用在表上的，也就意味着，不同的表可以有不同的存储引擎类型。
PerconaDB:默认是XtraDB
MariaDB:默认是InnoDB
其他的存储引擎支持:
TokuDB    
RocksDB
MyRocks
以上三种存储引擎的共同点:压缩比较高,数据插入性能极高
现在很多的NewSQL,使用比较多的功能特性.

```



### 5.1.1: InnoDB存储引擎介绍:

![](/images/posts/10_mysql/13.png)









## 5.2: 存储引擎查看:

### 5.2.1: 使用SELECT确认会话存储引擎:

```bash
SELECT @@default_storage_engine;
## 5.2 存储引擎(不代表生产操作)
会话级别:
set default_storage_engine=myisam;
全局级别(仅影响新会话):
set global default_storage_engine=myisam;
重启之后,所有参数均失效.
如果要永久生效:
写入配置文件
vim /etc/my.cnf
[mysqld]
default_storage_engine=myisam
存储引擎是表级别的,每个表创建时可以指定不同的存储引擎,但是我们建议统一为innodb.



#SHOW 确认每个表的存储引擎：
SHOW CREATE TABLE City\G;
SHOW TABLE STATUS LIKE 'CountryLanguage'\G

#INFORMATION_SCHEMA 确认每个表的存储引擎
[world]>select table_schema,table_name ,engine from information_schema.tables where table_schema not in ('sys','mysql','information_schema','performance_schema');
Master [world]>show table status;
Master [world]>show create table city;

#修改一个表的存储引擎
db01 [oldboy]>alter table t1 engine innodb;
注意：此命令我们经常使用他，进行innodb表的碎片整理
```



## 5.3：InnoDB存储引擎物理存储结构:

```bash
ibdata1：系统数据字典信息(统计信息)，UNDO表空间等数据
ib_logfile0 ~ ib_logfile1: REDO日志文件，事务日志文件。
ibtmp1： 临时表空间磁盘位置，存储临时表
frm：存储表的列信息
ibd：表的数据行和索引
```



### 5.3.1: 表空间(Tablespace)

```bash
需要将所有数据存储到同一个表空间中 ，管理比较混乱
5.5版本出现的管理模式，也是默认的管理模式。
5.6版本以，共享表空间保留，只用来存储:数据字典信息,undo,临时表。
5.7 版本,临时表被独立出来了
8.0版本,undo也被独立出去了
```



具体变化参考官方文档:
 [https://dev.mysql.com/doc/refman/5.6/en/innodb-architecture.html](https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Finnodb-architecture.html)
 [https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html](https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finnodb-architecture.html)
 [https://dev.mysql.com/doc/refman/5.8/en/innodb-architecture.html](https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.8%2Fen%2Finnodb-architecture.html)



### 5.3.2: 共享表空间设置:

```bash
共享表空间设置(在搭建MySQL时，初始化数据之前设置到参数文件中)
[(none)]>select @@innodb_data_file_path;
[(none)]>show variables like '%extend%';
innodb_data_file_path=ibdata1:512M:ibdata2:512M:autoextend
innodb_autoextend_increment=64
```



### 5.3.3: 独立表空间:

```bash
从5.6，默认表空间不再使用共享表空间，替换为独立表空间。
主要存储的是用户数据
存储特点为：一个表一个ibd文件，存储数据行和索引信息
基本表结构元数据存储：
xxx.frm
最终结论：
      元数据            数据行+索引
mysql表数据    =（ibdataX+frm）+ibd(段、区、页)
        DDL             DML+DQL

MySQL的存储引擎日志：
Redo Log: ib_logfile0  ib_logfile1，重做日志
Undo Log: ibdata1 ibdata2(存储在共享表空间中)，回滚日志
临时表:ibtmp1，在做join union操作产生临时数据，用完就自动

#独立表空间设置问题
db01 [(none)]>select @@innodb_file_per_table;
+-------------------------+
| @@innodb_file_per_table |
+-------------------------+
|                      1 |
+-------------------------+
alter table city dicard tablespace;
alter table city import tablespace;
```



#### 5.4: 案例：

```bash
#案例背景
硬件及软件环境:
联想服务器（IBM） 
磁盘500G 没有raid
centos 6.8
mysql 5.6.33  innodb引擎  独立表空间
备份没有，日志也没开

开发用户专用库:
jira(bug追踪) 、 confluence(内部知识库)    ------>LNMT

#故障描述

断电了，启动完成后“/” 只读
fsck  重启,系统成功启动,mysql启动不了。
结果：confulence库在  ， jira库不见了

#表空间迁移:
create table xxx
alter table  confulence.t1 discard tablespace;
alter table confulence.t1 import tablespace;
虚拟机测试可行。

出来思路:
confulence库中一共有107张表。
1、创建107和和原来一模一样的表。
他有2016年的历史库，我让他去他同时电脑上 mysqldump备份confulence库
mysqldump -uroot -ppassw0rd -B  confulence --no-data >test.sql
拿到你的测试库，进行恢复
到这步为止，表结构有了。
2、表空间删除。
select concat('alter table ',table_schema,'.'table_name,' discard tablespace;') from information_schema.tables where table_schema='confluence' into outfile '/tmp/discad.sql';
source /tmp/discard.sql
执行过程中发现，有20-30个表无法成功。主外键关系
很绝望，一个表一个表分析表结构，很痛苦。
set foreign_key_checks=0 跳过外键检查。
把有问题的表表空间也删掉了。
3、拷贝生产中confulence库下的所有表的ibd文件拷贝到准备好的环境中
select concat('alter table ',table_schema,'.'table_name,' import tablespace;') from information_schema.tables where table_schema='confluence' into outfile '/tmp/discad.sql';
4、验证数据
表都可以访问了，数据挽回到了出现问题时刻的状态（2-8）

```



### 5.3.4: 事务的ACID特性:

```bash
#Atomic（原子性）
所有语句作为一个单元全部成功执行或全部取消。不能出现中间状态。
#Consistent（一致性）
如果数据库在事务开始时处于一致状态，则在执行该事务期间将保留一致状态。
#Isolated（隔离性）
事务之间不相互影响。
#Durable（持久性）
事务成功完成后，所做的所有更改都会准确地记录在数据库中。所做的更改不会丢失。
```



## 5.4: 事务的生命周期:

### 5.4.1: 事务的开始:

```bash
begin
说明:在5.5 以上的版本，不需要手工begin，只要你执行的是一个DML，会自动在前面加一个begin命令。
```



### 5.4.2: 事务的结束:

```bash
commit：提交事务
完成一个事务，一旦事务提交成功 ，就说明具备ACID特性了。
rollback ：回滚事务
将内存中，已执行过的操作，回滚回去
```



### 5.4.3: 自动提交策略:

```bash
db01 [(none)]>select @@autocommit;
db01 [(none)]>set autocommit=0;
db01 [(none)]>set global autocommit=0;
注：
自动提交是否打开，一般在有事务需求的MySQL中，将其关闭
不管有没有事务需求，我们一般也都建议设置为0，可以很大程度上提高数据库性能
(1)
set autocommit=0;   
set global autocommit=0;
(2)
vim /etc/my.cnf
autocommit=0     
```

### 5.4.3: 开始事务流程:

```bash
1、检查autocommit是否为关闭状态
select @@autocommit;
或者：
show variables like 'autocommit';
2、开启事务,并结束事务
begin
delete from student where name='alexsb';
update student set name='alexsb' where name='alex';
rollback;

begin
delete from student where name='alexsb';
update student set name='alexsb' where name='alex';
commit;
```



# 六: 日志管理:



![](/images/posts/10_mysql/14.png)



## 6.1: 错误日志(log_error):

### 6.1.1: 错误日志配置:

```bash
#作用
记录启动\关闭\日常运行过程中,状态信息,警告,错误
默认就是开启的:  /数据路径下/hostname.err
手工设定:
Master [(none)]>select @@log_error;
vim /etc/my.cnf
log_error=/var/log/mysql.log
log_timestamps=system #新的日志时区会变成系统默认时区
重启生效
show variables like 'log_error';
```



## 6.2：binlog(binary logs) 二进制日志:

### 6.2.1: binlog配置:

```bash
#作用
(1)备份恢复必须依赖二进制日志
(2)主从环境必须依赖二进制日志

注意：MySQL默认是没有开启二进制日志的。
基础参数查看:
开关:
[(none)]>select @@log_bin;
日志路径及名字
[(none)]>select @@log_bin_basename;
服务ID号:
[(none)]>select @@server_id;
二进制日志格式:
[(none)]>select @@binlog_format;
双一标准之二:
[(none)]>select @@sync_binlog;
```



### 6.2.2：配置binlog日志:

```bash
mkdir /data/binlog
chown -R mysql.mysql /data/binlog

#修改配置文件
vim /etc/my.cnf
server_id=6                                    ----->5.6中，单机可以不需要此参数             
log_bin=/data/binlog/mysql-bin
binlog_format=row

# 重启数据库生效
[root@db01 mysql]# /etc/init.d/mysqld restart
```

### 6.2.3：参数说明:

```bash
server_id=3306 
主要是在主从复制过程中必须要加的,但是在5.7版本中,要用以下参数(log_bin),开启binlog日志,即使是单机也是必加的
log_bin=/data/binlog/mysql-bin
(1)开启二进制日志功能
(2)设置二进制日志目录及名称前缀
binlog_format=row
binlog的记录格式??
```



### 6.2.4: binlog三种记录方式:

```bash
#binlog是SQL层的功能。记录的是变更SQL语句，不记录查询语句。
#记录SQL语句种类
DDL ：原封不动的记录当前DDL(statement语句方式)。
DCL ：原封不动的记录当前DCL(statement语句方式)。
DML ：只记录已经提交的事务DML


binlog_format（binlog的记录格式）参数影响
（1）statement（5.6默认）SBR(statement based replication) ：语句模式原封不动的记录当前DML。
（2）ROW(5.7 默认值) RBR(ROW based replication) ：记录数据行的变化(用户看不懂，需要工具分析)
（3）mixed（混合）MBR(mixed based replication)模式  ：以上两种模式的混合



#SBR与RBR模式的对比
STATEMENT：可读性较高，日志量少，但是不够严谨
ROW      ：可读性很低，日志量大，足够严谨
```



## 6.3：event(事件)是什么?

### 6.3.1: 事件的简介:

```bash
#二进制日志的最小记录单元
对于DDL,DCL,一个语句就是一个event
对于DML语句来讲:只记录已提交的事务。
例如以下列子,就被分为了4个event
begin;      120  - 340
DML1        340  - 460
DML2        460  - 550
commit;     550  - 760


#event的组成

三部分构成:
(1) 事件的开始标识
(2) 事件内容
(3) 事件的结束标识
Position:
开始标识: at 194
结束标识: end_log_pos 254
194? 254?
某个事件在binlog中的相对位置号
位置号的作用是什么？
为了方便我们截取事件
```



## 6.5: 日志文件查看:

### 6.5.1: 查看日志的开启情况:

```bash
#log_bin参数设置的路径,可以找到二进制日志
mysql> show variables like '%log_bin%';
+---------------------------------+----------------------------------+
| Variable_name                   | Value                            |
+---------------------------------+----------------------------------+
| log_bin                         | ON                               |
| log_bin_basename                | /data/mysql/logs/mysql-bin       |
| log_bin_index                   | /data/mysql/logs/mysql-bin.index |
| log_bin_trust_function_creators | OFF                              |
| log_bin_use_v1_row_events       | OFF                              |
| sql_log_bin                     | ON                               |
+---------------------------------+----------------------------------+
6 rows in set (0.01 sec)


#查看一共多少个binlog
mysql> show binary logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |       154 |
+------------------+-----------+
1 row in set (0.00 sec)

mysql> flush logs;
Query OK, 0 rows affected (0.00 sec)

mysql> show binary logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |       201 |
| mysql-bin.000002 |       154 |
+------------------+-----------+
2 rows in set (0.00 sec)

mysql> flush logs;
Query OK, 0 rows affected (0.00 sec)

mysql> show binary logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |       201 |
| mysql-bin.000002 |       201 |
| mysql-bin.000003 |       154 |
+------------------+-----------+
3 rows in set (0.00 sec)

```



### 6.5.2：查看mysql正在使用的日志文件:

```bash
mysql> show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      154 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)


file：当前MySQL正在使用的文件名
Position：最后一个事件的结束位置号
```



### 6.5.3: 日志内存查看:

#### 6.5.3.1: event查看:

```bash
mysql> show binlog events in 'mysql-bin.000003';
+------------------+-----+----------------+-----------+-------------+---------------------------------------+
| Log_name         | Pos | Event_type     | Server_id | End_log_pos | Info                                  |
+------------------+-----+----------------+-----------+-------------+---------------------------------------+
| mysql-bin.000003 |   4 | Format_desc    |         6 |         123 | Server ver: 5.7.25-log, Binlog ver: 4 |
| mysql-bin.000003 | 123 | Previous_gtids |         6 |         154 |                                       |
| mysql-bin.000003 | 154 | Anonymous_Gtid |         6 |         219 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000003 | 219 | Query          |         6 |         307 | create database v1                    |
| mysql-bin.000003 | 307 | Anonymous_Gtid |         6 |         372 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000003 | 372 | Query          |         6 |         467 | use `v1`; create table test(id int)   |
+------------------+-----+----------------+-----------+-------------+---------------------------------------+
6 rows in set (0.00 sec)

Log_name：binlog文件名
Pos：开始的position    *****
Event_type：事件类型
Format_desc：格式描述，每一个日志文件的第一个事件，多用户没有意义，MySQL识别binlog必要信息
Server_id：mysql服务号标识
End_log_pos：事件的结束位置号 *****
Info：事件内容*****
补充:
SHOW BINLOG EVENTS
   [IN 'log_name']
   [FROM pos]
   [LIMIT [offset,] row_count]
[root@db01 binlog]# mysql -e "show binlog events in 'mysql-bin.000004'" |grep drop
```



#### 6.5.3.2: binlog文件内容详细查看:

```bash
# mysqlbinlog /data/mysql/logs/mysql-bin.000003
]# mysqlbinlog --base64-output=decode-rows -vvv /data/mysql/logs/mysql-bin.000003 
# mysqlbinlog -d binlog  /data/mysql/logs/mysql-bin.000003
-d #指定某个库查看
[root@db01 binlog]# mysqlbinlog --start-datetime='2019-05-06 17:00:00' --stop-datetime='2019-05-06 17:01:00'  /data/binlog/mysql-bin.000004
```



### 6.5.2：基于Position号进行日志截取:

```bash
核心就是找截取的起点和终点
--start-position=321
--stop-position=513
 mysqlbinlog --start-position=219 --stop-position=1347 /data/binlog/mysql-bin.000003 >/tmp/bin.sql

案例: 使用binlog日志进行数据恢复
模拟:
1. 
[(none)]>create database binlog charset utf8;
2. 
[(none)]>use binlog;
[binlog]>create table t1(id int);
3. 
[binlog]>insert into t1 values(1);
[binlog]>commit;
[binlog]>insert into t1 values(2);
[binlog]>commit;
[binlog]>insert into t1 values(3);
[binlog]>commit;
4. 
[binlog]>drop database binlog;
恢复:
[(none)]>show master status ;
[(none)]>show binlog events in 'mysql-bin.000004';
[root@db01 binlog]# mysqlbinlog --start-position=1227 --stop-position=2342 /data/binlog/mysql-bin.000004 >/tmp/bin.sql
[(none)]>set sql_Log_bin=0;
[(none)]>source /tmp/bin.sql

面试案例:
1. 备份策略每天全备,有全量的二进制日志
2.业务中一共10个库,其中一个被误drop了
3. 需要在其他9个库正常工作过程中进行数据恢复

```



## 6.6: binlog日志的GTID新特性：

### 6.6.1：GTID介绍:

```bash
5.6 版本新加的特性,5.7中做了加强
5.6 中不开启,没有这个功能.
5.7 中的GTID,即使不开也会有自动生成
SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
```



### 6.6.2: GTID(Global Transaction ID):

```bash
是对于一个已提交事务的编号，并且是一个全局唯一的编号。
它的官方定义如下：

GTID = source_id ：transaction_id
7E11FA47-31CA-19E1-9E56-C43AA21293967:29

重要参数介绍:
vim /etc/my.cnf
gtid-mode=on  #开启gtid功能
enforce-gtid-consistency=true  #保证事务安全完整性的
systemctl restart mysqld


Master [(none)]>create database gtid charset utf8;
Query OK, 1 row affected (0.01 sec)

Master [(none)]>show master status ;
+------------------+----------+--------------+------------------+----------------------------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                      |
+------------------+----------+--------------+------------------+----------------------------------------+
| mysql-bin.000004 |      326 |              |                  | dff98809-55c3-11e9-a58b-000c2928f5dd:1 |
+------------------+----------+--------------+------------------+----------------------------------------+
1 row in set (0.00 sec)

Master [(none)]>use gtid
Database changed
Master [gtid]>create table t1 (id int);
Query OK, 0 rows affected (0.01 sec)

Master [gtid]>show master status ;
+------------------+----------+--------------+------------------+------------------------------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |
+------------------+----------+--------------+------------------+------------------------------------------+
| mysql-bin.000004 |      489 |              |                  | dff98809-55c3-11e9-a58b-000c2928f5dd:1-2 |
+------------------+----------+--------------+------------------+------------------------------------------+
1 row in set (0.00 sec)

Master [gtid]>create table t2 (id int);
Query OK, 0 rows affected (0.01 sec)

Master [gtid]>create table t3 (id int);
Query OK, 0 rows affected (0.02 sec)

Master [gtid]>show master status ;
+------------------+----------+--------------+------------------+------------------------------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |
+------------------+----------+--------------+------------------+------------------------------------------+
| mysql-bin.000004 |      815 |              |                  | dff98809-55c3-11e9-a58b-000c2928f5dd:1-4 |
+------------------+----------+--------------+------------------+------------------------------------------+
1 row in set (0.00 sec)

Master [gtid]>begin;
Query OK, 0 rows affected (0.00 sec)

Master [gtid]>insert into t1 values(1);
Query OK, 1 row affected (0.00 sec)

Master [gtid]>commit;
Query OK, 0 rows affected (0.00 sec)

Master [gtid]>show master status ;
+------------------+----------+--------------+------------------+------------------------------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |
+------------------+----------+--------------+------------------+------------------------------------------+
| mysql-bin.000004 |     1068 |              |                  | dff98809-55c3-11e9-a58b-000c2928f5dd:1-5 |
+------------------+----------+--------------+------------------+------------------------------------------+
1 row in set (0.00 sec)

Master [gtid]>begin;
Query OK, 0 rows affected (0.00 sec)

Master [gtid]>insert into t2 values(1);
Query OK, 1 row affected (0.00 sec)

Master [gtid]>commit;
Query OK, 0 rows affected (0.01 sec)

Master [gtid]>show master status ;
+------------------+----------+--------------+------------------+------------------------------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |
+------------------+----------+--------------+------------------+------------------------------------------+
| mysql-bin.000004 |     1321 |              |                  | dff98809-55c3-11e9-a58b-000c2928f5dd:1-6 |
+------------------+----------+--------------+------------------+------------------------------------------+
1 row in set (0.00 sec)


  参数说明：
    --include-gtids    截取指定的gtid
    --exclude-gtids    排除指定的gtid
    --skip-gtids       跳过gtid的幂等性机制的检查，即截取日志的时候不带有gtid的信息
  
  
  
  
 #基于GTID进行查看binlog  
 [root@localhost ~]# mysqlbinlog --include-gtids='e27ea2cc-9f82-11ee-9103-000c2903d870:1-7' --exclude-gtids='e27ea2cc-9f82-11ee-9103-000c2903d870:4' /data/mysql/logs/mysql-bin.000005



#GTID的冥等性

开启GTID后,MySQL恢复Binlog时,重复GTID的事务不会再执行了
就想恢复?怎么办?
--skip-gtids
mysqlbinlog --include-gtids='3ca79ab5-3e4d-11e9-a709-000c293b577e:4' /data/binlog/mysql-bin.000004 /data/binlog/mysql-bin.000004
set sql_log_bin=0;
source /tmp/binlog.sql
set sql_log_bin=1;
```



### 6.6.3：使用二进制日志恢复案例:

```bash
创建了一个库  db, 导入了表t1 ,t1表中录入了很多数据
一个开发人员,drop database db;
没有备份,日志都在.怎么恢复?
思路:找到建库语句到删库之前所有的日志,进行恢复.(开启了GTID模式)
故障案例模拟:
(0) drop database if exists db ;
(1) create database db charset utf8;     
(2) use db;
(3) create table t1 (id int);
(4) insert into t1 values(1),(2),(3);
(5) insert into t1 values(4),(5),(6);
(6) commit
(7) update t1 set id=30 where id=3;
(8) commit;
(9) delete from t1 where id=4;
(10)commit;
(11)insert into t1 values(7),(8),(9);
(12)commit;
(13)drop database db;
========================
drop database if exists db ;
create database db charset utf8; 
use db;
create table t1 (id int);
insert into t1 values(1),(2),(3);
insert into t1 values(4),(5),(6);
commit;
update t1 set id=30 where id=3;
commit;
delete from t1 where id=4;
commit;
insert into t1 values(7),(8),(9);
commit;
drop database db;
=======
运行以上语句，模拟故障场景
需求：将数据库恢复到以下状态（提示第9步和第13步是误操作，其他都是正常操作）
```



### 6.6.4: 恢复过程（无GTID时的恢复）

1.查看当前使用binlog文件

```bash
mysql> show binlog events in 'mysql-bin.000001';
+------------------+------+----------------+-----------+-------------+---------------------------------------+
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info                                  |
+------------------+------+----------------+-----------+-------------+---------------------------------------+
| mysql-bin.000001 |    4 | Format_desc    |         6 |         123 | Server ver: 5.7.25-log, Binlog ver: 4 |
| mysql-bin.000001 |  123 | Previous_gtids |         6 |         154 |                                       |
| mysql-bin.000001 |  154 | Anonymous_Gtid |         6 |         219 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 |  219 | Query          |         6 |         320 | create database db charset utf8       |
| mysql-bin.000001 |  320 | Anonymous_Gtid |         6 |         385 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 |  385 | Query          |         6 |         479 | use `db`; create table t1 (id int)    |
| mysql-bin.000001 |  479 | Anonymous_Gtid |         6 |         544 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 |  544 | Query          |         6 |         614 | BEGIN                                 |
| mysql-bin.000001 |  614 | Table_map      |         6 |         657 | table_id: 109 (db.t1)                 |
| mysql-bin.000001 |  657 | Write_rows     |         6 |         707 | table_id: 109 flags: STMT_END_F       |
| mysql-bin.000001 |  707 | Xid            |         6 |         738 | COMMIT /* xid=20 */                   |
| mysql-bin.000001 |  738 | Anonymous_Gtid |         6 |         803 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 |  803 | Query          |         6 |         873 | BEGIN                                 |
| mysql-bin.000001 |  873 | Table_map      |         6 |         916 | table_id: 109 (db.t1)                 |
| mysql-bin.000001 |  916 | Write_rows     |         6 |         966 | table_id: 109 flags: STMT_END_F       |
| mysql-bin.000001 |  966 | Xid            |         6 |         997 | COMMIT /* xid=21 */                   |
| mysql-bin.000001 |  997 | Anonymous_Gtid |         6 |        1062 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 | 1062 | Query          |         6 |        1132 | BEGIN                                 |
| mysql-bin.000001 | 1132 | Table_map      |         6 |        1175 | table_id: 109 (db.t1)                 |
| mysql-bin.000001 | 1175 | Update_rows    |         6 |        1221 | table_id: 109 flags: STMT_END_F       |
| mysql-bin.000001 | 1221 | Xid            |         6 |        1252 | COMMIT /* xid=23 */                   |
| mysql-bin.000001 | 1252 | Anonymous_Gtid |         6 |        1317 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 | 1317 | Query          |         6 |        1387 | BEGIN                                 |
| mysql-bin.000001 | 1387 | Table_map      |         6 |        1430 | table_id: 109 (db.t1)                 |
| mysql-bin.000001 | 1430 | Delete_rows    |         6 |        1470 | table_id: 109 flags: STMT_END_F       |
| mysql-bin.000001 | 1470 | Xid            |         6 |        1501 | COMMIT /* xid=25 */                   |
| mysql-bin.000001 | 1501 | Anonymous_Gtid |         6 |        1566 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 | 1566 | Query          |         6 |        1636 | BEGIN                                 |
| mysql-bin.000001 | 1636 | Table_map      |         6 |        1679 | table_id: 109 (db.t1)                 |
| mysql-bin.000001 | 1679 | Write_rows     |         6 |        1729 | table_id: 109 flags: STMT_END_F       |
| mysql-bin.000001 | 1729 | Xid            |         6 |        1760 | COMMIT /* xid=27 */                   |
| mysql-bin.000001 | 1760 | Anonymous_Gtid |         6 |        1825 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000001 | 1825 | Query          |         6 |        1911 | drop database db                      |
+------------------+------+----------------+-----------+-------------+---------------------------------------+
33 rows in set (0.00 sec)

[root@localhost data]# mysqlbinlog --start-position=219 --stop-position=1252 /data/mysql-bin.000001 > /tmp/bin.sql
[root@localhost data]# mysqlbinlog --start-position=1566 --stop-position=1760 /data/mysql-bin.000001 > /tmp/bin2.sql



#恢复

mysql> set sql_log_bin=0;
Query OK, 0 rows affected (0.00 sec)
mysql> source /tmp/bin.sql
mysql> source /tmp/bin2.sql
mysql> set sql_log_bin=1;

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| db                 |
| mysql              |
| performance_schema |
| sys                |
| world_area         |
+--------------------+
6 rows in set (0.00 sec)

mysql> use db;
Database changed
mysql> show tables;
+--------------+
| Tables_in_db |
+--------------+
| t1           |
+--------------+
1 row in set (0.00 sec)

mysql> select * from t1;
+------+
| id   |
+------+
|    1 |
|    2 |
|   30 |
|    4 |
|    5 |
|    6 |
|    7 |
|    8 |
|    9 |
+------+
9 rows in set (0.00 sec)

```



### 6.6.5：有GTID的恢复:

```bash
#截取
--skip-gtids  重复的ID不在执行
--exclude-gtids 跳过id号
[root@localhost ~]# mysqlbinlog --skip-gtids --include-gtids='e27ea2cc-9f82-11ee-9103-000c2903d870:15-21' --exclude-gtids='e27ea2cc-9f82-11ee-9103-000c2903d870:20' /data/mysql-bin.000002 > /root/bin.sql

#恢复
mysql>set sql_log_bin=0;
mysql>source /root/bin.sql

#验证
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| db                 |
| mysql              |
| performance_schema |
| sys                |
| world_area         |
+--------------------+
6 rows in set (0.00 sec)
mysql> use db;
Database changed
mysql> show tables;
+--------------+
| Tables_in_db |
+--------------+
| t1           |
+--------------+
1 row in set (0.00 sec)

mysql> select * from t1;
+------+
| id   |
+------+
|    1 |
|    2 |
|   30 |
|    4 |
|    5 |
|    6 |
|    7 |
|    8 |
|    9 |
+------+
9 rows in set (0.00 sec)


```



## 6.7：二进制日志其他操作:

### 6.7.1: 自动清理日志:

```bash
mysql> show variables like '%expire%';
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| disconnect_on_expired_password | ON    | #密码过期超时断开
| expire_logs_days               | 0     | #日志过期时间，若expire_logs_days=0，则为永不过期哦
+---------------------------


自动清理时间,是要按照全备周期+1
set global expire_logs_days=8;
永久生效:
my.cnf
expire_logs_days=15;
企业建议,至少保留两个全备周期+1的binlog

*reset master; 主从关系中，主库执行此操作，主从环境必崩
```



### 6.7.2：手工清理:

```bash
#清楚当前时间3天之前的
PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day;

#清除某个日志：
PURGE BINARY LOGS TO 'mysql-bin.000010';
#清楚某个日期之前的
mysql> purge binary logs before '2020-12-20';

注意:不要手工 rm binlog文件
1. my.cnf binlog关闭掉,启动数据库
2.把数据库关闭,开启binlog,启动数据库
删除所有binlog,并从000001开始重新记录日志
```



### 6.7.3：日志怎么滚动:

```bash
flush logs; 
重启mysql也会自动滚动一个新的
日志文件达到1G大小(max_binlog_size)
| max_binlog_size                          | 1073741824     
备份时,加入参数也可以自动滚动
max_binlog_size=500M     #日志最多存放500M，超过500M后会被清除
```



## 6.8: 开启慢日志(默认没开启):

```bash
开关:
slow_query_log=1 
文件位置及名字 
slow_query_log_file=/data/mysql/slow.log
设定慢查询时间:
long_query_time=0.1
没走索引的语句也记录:
log_queries_not_using_indexes
vim /etc/my.cnf
slow_query_log=1 
slow_query_log_file=/data/mysql/slow.log
long_query_time=0.1
log_queries_not_using_indexes
systemctl restart mysqld
```



### 6.8.1: mysqldumpslow 分析慢日志:

```bash
mysqldumpslow -s c -t 10 /data/mysql/slow.log

# 第三方工具(自己扩展)
https://www.percona.com/downloads/percona-toolkit/LATEST/
yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes perl-IO-Socket-SSL perl-Digest-MD5
toolkit工具包中的命令:
./pt-query-diagest  /data/mysql/slow.log
Anemometer基于pt-query-digest将MySQL慢查询可视化
```



# 七：备份恢复:

## 7.1: 备份类型:

```bash
#热备
在数据库正常业务时,备份数据,并且能够一致性恢复（只能是innodb）
对业务影响非常小
#温备
锁表备份,只能查询不能修改（myisam）
影响到写入操作
#冷备
关闭数据库业务,数据库没有任何变更的情况下,进行备份数据.
业务停止
```

### 7.1.1：备份方式及工具介绍:

```bash
#逻辑备份工具
基于SQL语句进行备份
mysqldump       *****
mysqlbinlog     *****
#物理备份工具
基于磁盘数据文件备份
xtrabackup(XBK) ：percona 第三方   *****
MySQL Enterprise Backup（MEB）
```



### 7.1.2：逻辑备份和物理备份的比较:

#### 7.1.2.1: mysqldump(MDP):

```bash
优点：
1.不需要下载安装
2.备份出来的是SQL，文本格式，可读性高,便于备份处理
3.压缩比较高，节省备份的磁盘空间

缺点：
4.依赖于数据库引擎，需要从磁盘把数据读出
然后转换成SQL进行转储，比较耗费资源，数据量大的话效率较低
建议：
100G以内的数据量级，可以使用mysqldump
超过TB以上，我们也可能选择的是mysqldump，配合分布式的系统
1EB  =1024 PB =1000000 TB
```



#### 7.1.2.2: xtrabackup(XBK):

```bash
优点：
1.类似于直接cp数据文件，不需要管逻辑结构，相对来说性能较高
缺点：
2.可读性差
3.压缩比低，需要更多磁盘空间
建议：
>100G<TB
```



#### 7.1.2.3: 备份策略:

```bash
备份方式：
全备:全库备份，备份所有数据
增量:备份变化的数据
逻辑备份=mysqldump+mysqlbinlog
物理备份=xtrabackup_full+xtrabackup_incr+binlog或者xtrabackup_full+binlog
备份周期:
根据数据量设计备份周期
比如：周日全备，周1-周6增量
```



## 7.2: 备份工具使用-mysqldump：

### 7.2.1：mysqldump通用参选:

```bash
-A 全被参数
[root@localhost ~]# mkdir /data/backup
[root@localhost ~]# mysqldump -uroot -p123456 -S /data/mysql.sock -A > /data/backup/full.sql
mysqldump: [Warning] Using a password on the command line interface can be insecure.

#gitd备份
例子1:
[root@db01 ~]# mkdir -p /data/backup
mysqldump -uroot -p -A >/data/backup/full.sql
Enter password: 

mysqldump: [Warning] Using a password on the command line interface can be insecure.
Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. 

# 补充:
# 1.常规备份是要加 --set-gtid-purged=OFF,解决备份时的警告
# [root@db01 ~]# mysqldump -uroot -p123 -A  --set-gtid-purged=OFF  >/backup/full.sql
# 2.构建主从时,做的备份,不需要加这个参数
# [root@db01 ~]# mysqldump -uroot -p123 -A    --set-gtid-purged=ON >/backup/full.sql


-B aa db 备份多个单库
说明：生产中需要备份，生产相关的库和MySQL库
[root@localhost backup]# mysqldump -uroot -p123456 -S /data/mysql.sock -B db aa > /data/backup/all.sql


#备份单个或多个表
db库下的 t1,t2表
[root@localhost backup]# mysqldump -uroot -p123456 -S /data/mysql.sock db t1 t2 > /data/backup/db.sql
```



### 7.2.2：高级参数应用:

```bash
-R            备份存储过程及函数
--triggers  备份触发器
-E             备份事件

例子4:
[root@db01 backup]# mysqldump -uroot -p -A -R -E --triggers >/data/backup/full.sql
(5) 特殊参数2使用


-F 在备份开始时,刷新一个新binlog日志
例子5:
mysqldump -uroot -p  -A  -R --triggers -F >/bak/full.sql

--master-data=2

以注释的形式,保存备份开始时间点的binlog的状态信息

mysqldump -uroot -p  -A  -R --triggers --master-data=2   >/back/world.sql
[root@db01 ~]# grep 'CHANGE' /backup/world.sql 
-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000035', MASTER_LOG_POS=194;

功能：
（1）在备份时，会自动记录，二进制日志文件名和位置号
0 默认值
1  以change master to命令形式，可以用作主从复制
2  以注释的形式记录，备份时刻的文件名+postion号
（2） 自动锁表
（3）如果配合--single-transaction，只对非InnoDB表进行锁表备份，InnoDB表进行“热“”备，实际上是实现快照备份。

--single-transaction

innodb 存储引擎开启热备(快照备份)功能       
master-data可以自动加锁
（1）在不加--single-transaction ，启动所有表的温备份，所有表都锁定
（1）加上--single-transaction ,对innodb进行快照备份,对非innodb表可以实现自动锁表功能
例子6: 备份必加参数
mysqldump -uroot -p -A -R -E --triggers --master-data=2  --single-transaction --set-gtid-purged=OFF >/data/backup/full.sql

--set-gtid-purged=auto
auto , on
off 
使用场景:
1. --set-gtid-purged=OFF,可以使用在日常备份参数中.
mysqldump -uroot -p -A -R -E --triggers --master-data=2  --single-transaction --set-gtid-purged=OFF >/data/backup/full.sql
2. auto , on:在构建主从复制环境时需要的参数配置
mysqldump -uroot -p -A -R -E --triggers --master-data=2  --single-transaction --set-gtid-purged=ON >/data/backup/full.sql

--max-allowed-packet=#
mysqldump -uroot -p -A -R -E --triggers --master-data=2  --single-transaction --set-gtid-purged=OFF --max-allowed-packet=256M >/data/backup/full.sql

 --max-allowed-packet=# 
The maximum packet length to send to or receive from server.

```



### 7.2.3: 实现所有表单独备份:

```bash
提示：
information_schema.tables
mysqldump -uroot -p123 world city >/backup/world_city.sql

mysql> select concat("mysqldump -uroot -p123456 -S /data/mysql.sock ",table_schema," ",table_name," >/data/backup/",table_schema,"_",table_name,".sql") from information_schema.tables where table_schema not in ('sys','information_schema','performance_schema') into outfile '/data/mysqldump.sh';
Query OK, 40 rows affected (0.00 sec)

[root@localhost data]# cat mysqldump.sh 
mysqldump -uroot -p123456 -S /data/mysql.sock aa t1 >/data/backup/aa_t1.sql
mysqldump -uroot -p123456 -S /data/mysql.sock aa t2 >/data/backup/aa_t2.sql
mysqldump -uroot -p123456 -S /data/mysql.sock db t1 >/data/backup/db_t1.sql
mysqldump -uroot -p123456 -S /data/mysql.sock db t2 >/data/backup/db_t2.sql
mysqldump -uroot -p123456 -S /data/mysql.sock db t3 >/data/backup/db_t3.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql columns_priv >/data/backup/mysql_columns_priv.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql db >/data/backup/mysql_db.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql engine_cost >/data/backup/mysql_engine_cost.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql event >/data/backup/mysql_event.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql func >/data/backup/mysql_func.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql general_log >/data/backup/mysql_general_log.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql gtid_executed >/data/backup/mysql_gtid_executed.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql help_category >/data/backup/mysql_help_category.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql help_keyword >/data/backup/mysql_help_keyword.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql help_relation >/data/backup/mysql_help_relation.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql help_topic >/data/backup/mysql_help_topic.sql
mysqldump -uroot -p123456 -S /data/mysql.sock mysql innodb_index_stats >/data/backup/mysql_innodb_index_sta
```



### 7.2.4：模拟故障案例并恢复:

```bash
（1）每天全备
（2）binlog日志是完整
（3）模拟白天的数据变化
（4）模拟下午两点误删除数据库

需求： 利用全备+binlog回复数据库误删除之前。
故障模拟及恢复：
1. 模拟周一23:00的全备
mysqldump -uroot -p -A -R -E --triggers --master-data=2  --single-transaction --set-gtid-purged=OFF >/data/backup/full.sql
2. 模拟白天的数据变化
Master [(none)]>create database day1 charset utf8;
Master [(none)]>use day1
Master [day1]>create table t1(id int);
Master [day1]>insert into t1 values(1),(2),(3);
Master [day1]>commit;
Master [world]>mysql> update t1 set id=1 where id=111;
Master [world]>commit;
模拟磁盘损坏：
[root@db01 data]# \rm -rf /data/mysql/data/*
3. 恢复故障
[root@db01 data]# pkill mysqld
[root@db01 data]# \rm -rf /data/mysql/data/*
4. 恢复思路
1.检查备份可用性
2.从备份中获取二进制日志位置
3.根据日志位置截取需要的二进制日志
4.初始化数据库,并启动
5.恢复全备
6.恢复二进制日志



```



### 7.2.5: 数据恢复:

```bash
例子：
mysqldump -uroot -p123 -A  -R  --triggers --master-data=2  --single-transaction|gzip > /backup/full_$(date +%F).sql.gz
mysqldump -uroot -p123 -A  -R  --triggers --master-data=2  --single-transaction|gzip > /backup/full_$(date +%F-%T).sql.gz


#获取gitid号
[root@localhost backup]# head all.sql 
-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000005', MASTER_LOG_POS=194;
#截取需要的数据
[root@localhost backup]# mysqlbinlog --start-position=194  /data/mysql-bin.000005 > /tmp/bin.sql

#数据库初始化
mysqld --initialize-insecure  --user=mysql --basedir=/app/mysql --datadir=/data/mysql

#启动数据库
[root@localhost backup]# systemctl start mysqld
#进入数据库
[root@localhost backup]# mysql
mysqldump备份的恢复方式（在生产中恢复要谨慎，恢复会删除重复的表）
mysql> set sql_log_bin=0;
#恢复全备
mysql> source /data/backup/all.sql
#恢复二进制日志
mysql> source /tmp/bin.sql

注意：
1、mysqldump在备份和恢复时都需要mysql实例启动为前提。
2、一般数据量级100G以内，大约15-45分钟可以恢复，数据量级很大很大的时候（PB、EB）
3、mysqldump是覆盖形式恢复的方法。

一般我们认为，在同数据量级，物理备份要比逻辑备份速度快.
逻辑备份的优势:
1、可读性强
2、压缩比很高
```



### 7.2.6: 企业级恢复案例:

```bash
#故障时间点
年底故障演练:模拟周三上午10点误删除数据库，并进行恢复.
#备份策略
每天23:00点，计划任务调用mysqldump执行全备脚本

#思路
1、停业务，避免数据的二次伤害
2、找一个临时库，恢复周三23：00全备
3、截取周二23：00  --- 周三10点误删除之间的binlog，恢复到临时库
4、测试可用性和完整性
5、 
    5.1 方法一：直接使用临时库顶替原生产库，前端应用割接到新库
    5.2 方法二：将误删除的表导出，导入到原生产库
6、开启业务
处理结果：经过20分钟的处理，最终业务恢复正常
```



#### 7.2.6.1：故障模拟演练:

```bash
#准备数据
create database backup;
use backup
create table t1 (id int);
insert into t1 values(1),(2),(3);
commit;
rm -rf /backup/*

#备份
[root@localhost backup]# mysqldump -uroot -p123456 -A -S /data/mysql.sock  -R  --triggers --set-gtid-purged=OFF --master-data=2  --single-transaction|gzip > /data/backup/full_$(date +%F).sql.gz
#模拟数据变化
use backup
insert into t1 values(11),(22),(33);
commit;
create table t2 (id int);
insert into t2 values(11),(22),(33);

#模拟故障，删除数据库
mysql> drop database backup;




#恢复过程
#准备临时数据库
mkdir 3307
mysqld --initialize-insecure  --user=mysql --basedir=/app/mysql --datadir=/data/3307
[root@localhost data]# cat /etc/systemd/system/mysqld3307.service 
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/etc/my3307.cnf
LimitNOFILE = 65536
LimitNPROC = 65536

[root@localhost data]# cat /etc/my3307.cnf 
[mysqld]
user=mysql
basedir=/app/mysql
datadir=/data/3307
port=3307
default-storage-engine=INNODB
socket=/tmp/mysql.sock
[mysql]
default-character-set=utf8 
socket=/tmp/mysql.sock

systemctl start mysqld3307





#准备全备：
cd /backup
gunzip full_2018-10-17.sql.gz 
（2）截取二进制日志
CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000014', MASTER_LOG_POS=1053;
[root@localhost backup]# mysql -uroot -p123456 -e "show binlog events in 'mysql-bin.000014'" | tail -100 | grep -i 'drop'


[root@localhost backup]# mysqlbinlog --skip-gtids --start-position=1053 --stop-position=1819 -d backup /data/mysql-bin.000014 > /tmp/back.sql

#进入数据库
[root@localhost backup]# mysqladmin -uroot -p password 123456 -S  /tmp/mysql.sock
[root@localhost backup]# mysql -uroot -p123456 -S /tmp/mysql.sock
mysql> set sql_log_bin=0;
#恢复全备
mysql> source /data/backup/full_2024-02-26.sql
#恢复二进制日志
mysql> source /tmp/bakcup.sql

#数据验证
mysql> use backup;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+------------------+
| Tables_in_backup |
+------------------+
| t1               |
| t2               |
+------------------+
2 rows in set (0.00 sec)

mysql> select * from t2;
+------+
| id   |
+------+
|   11 |
|   22 |
|   33 |
+------+
3 rows in set (0.00 sec)

```

# 八：MySQL物理备份工具-xtrbackup(XBK):

## 8.1: 安装依赖包:

```bash
[root@localhost ~]#wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
[root@localhost ~]#yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev

[root@localhost ~]#wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm

[root@localhost ~]# yum -y install percona-xtrabackup-24-2.4.12-1.el7.x86_64.rp

#备份命令
xtrabackup
innobackupex    ******
```



## 8.2：备份方式-物理备份:

```bash
（1）对于非Innodb表（比如 myisam）是，锁表cp数据文件，属于一种温备份。
（2）对于Innodb的表（支持事务的），不锁表，拷贝数据页，最终以数据文件的方式保存下来，把一部分redo和undo一并备走，属于热备方式。
```



### 8.2.1: xbk在innodb表备份恢复的流程:

```bash
  0、xbk备份执行的瞬间,立即触发ckpt,已提交的数据脏页,从内存刷写到磁盘,并记录此时的LSN号
  1、备份时，拷贝磁盘数据页，并且记录备份过程中产生的redo和undo一起拷贝走,也就是checkpoint LSN之后的日志
  2、在恢复之前，模拟Innodb“自动故障恢复”的过程，将redo（前滚）与undo（回滚）进行应用
  3、恢复过程是cp 备份到原来数据目录下
```



## 8.3: innobackupex使用:

### 8.3.1: 全备:

```bash
#全备报错找不到mysql.sock
[root@localhost ~]# innobackupex --user=root --password=123456 /data/backup
xtrabackup: recognized server arguments: --datadir=/data/mysql --server-id=6 --log_bin=/data/mysql-bin 
xtrabackup: recognized client arguments: --datadir=/data/mysql --server-id=6 --log_bin=/data/mysql-bin 
240301 11:44:33 innobackupex: Starting the backup operation

IMPORTANT: Please check that the backup run completes successfully.
           At the end of a successful backup run innobackupex
           prints "completed OK!".

240301 11:44:33  version_check Connecting to MySQL server with DSN 'dbi:mysql:;mysql_read_default_group=xtrabackup' as 'root'  (using password: YES).
Failed to connect to MySQL server: DBI connect(';mysql_read_default_group=xtrabackup','root',...) failed: Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2) at - line 1314.
240301 11:44:33 Connecting to MySQL server host: localhost, user: root, password: set, port: not set, socket: not set
Failed to connect to MySQL server: Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2).

#在配置文件添加
vim /etc/my.cnf
[client]
socket=/data/mysql.sock

[root@localhost ~]# innobackupex --user=root --password=123456 /data/backup
xtrabackup: recognized server arguments: --datadir=/data/mysql --server-id=6 --log_bin=/data/mysql-bin 
xtrabackup: recognized client arguments: --datadir=/data/mysql --server-id=6 --log_bin=/data/mysql-bin 
240301 11:46:48 innobackupex: Starting the backup operation
......
240301 11:46:50 completed OK!

#验证
[root@localhost backup]# ll /data/backup/
total 0
drwxr-x--- 9 root root 273 Mar  1 11:48 2024-03-01_11-48-10
[root@localhost backup]# ll /data/backup/2024-03-01_11-48-10/
total 12340
drwxr-x--- 2 root root       76 Mar  1 11:48 aa
-rw-r----- 1 root root      487 Mar  1 11:48 backup-my.cnf
drwxr-x--- 2 root root       48 Mar  1 11:48 day1
drwxr-x--- 2 root root      104 Mar  1 11:48 db
-rw-r----- 1 root root      419 Mar  1 11:48 ib_buffer_pool
-rw-r----- 1 root root 12582912 Mar  1 11:48 ibdata1
drwxr-x--- 2 root root     4096 Mar  1 11:48 mysql
drwxr-x--- 2 root root     8192 Mar  1 11:48 performance_schema
drwxr-x--- 2 root root     8192 Mar  1 11:48 sys
drwxr-x--- 2 root root      160 Mar  1 11:48 world_area
-rw-r----- 1 root root       22 Mar  1 11:48 xtrabackup_binlog_info
-rw-r----- 1 root root      113 Mar  1 11:48 xtrabackup_checkpoints
-rw-r----- 1 root root      471 Mar  1 11:48 xtrabackup_info
-rw-r----- 1 root root     2560 Mar  1 11:48 xtrabackup_logfile

```



### 8.3.2: 自主定制备份路径名:

```bash
[root@localhost backup]# innobackupex --user=root --password=123456 --no-timestamp /data/backup/full

[root@localhost backup]# ll /data/backup/full/
total 12340
drwxr-x--- 2 root root       76 Mar  1 11:51 aa
-rw-r----- 1 root root      487 Mar  1 11:51 backup-my.cnf
drwxr-x--- 2 root root       48 Mar  1 11:51 day1
drwxr-x--- 2 root root      104 Mar  1 11:51 db
-rw-r----- 1 root root      419 Mar  1 11:51 ib_buffer_pool
-rw-r----- 1 root root 12582912 Mar  1 11:50 ibdata1
drwxr-x--- 2 root root     4096 Mar  1 11:51 mysql
drwxr-x--- 2 root root     8192 Mar  1 11:51 performance_schema
drwxr-x--- 2 root root     8192 Mar  1 11:51 sys
drwxr-x--- 2 root root      160 Mar  1 11:51 world_area
-rw-r----- 1 root root       22 Mar  1 11:51 xtrabackup_binlog_info
-rw-r----- 1 root root      113 Mar  1 11:51 xtrabackup_checkpoints
-rw-r----- 1 root root      491 Mar  1 11:51 xtrabackup_info
-rw-r----- 1 root root     2560 Mar  1 11:51 xtrabackup_logfile





#备份集中多出来的文件

-rw-r----- 1 root root       22 Mar  1 11:51 xtrabackup_binlog_info
-rw-r----- 1 root root      113 Mar  1 11:51 xtrabackup_checkpoints
-rw-r----- 1 root root      491 Mar  1 11:51 xtrabackup_info
-rw-r----- 1 root root     2560 Mar  1 11:51 xtrabackup_logfile


xtrabackup_binlog_info：（备份时刻的binlog位置）
[root@localhost full]# cat xtrabackup_binlog_info 
mysql-bin.000014	1917
#记录的是备份时刻，binlog的文件名字和当时的结束的position，可以用来作为截取binlog时的起点。


xtrabackup_checkpoints：（记录LSN号）
[root@localhost full]# cat xtrabackup_checkpoints 
backup_type = full-backuped  #备份类型为全备
from_lsn = 0				#上次所到达的LSN号(对于全备就是从0开始,对于增量有别的显示方法)
to_lsn = 4712872            #备份开始时间(ckpt)点数据页的LSN
last_lsn = 4712881			#备份结束后，redo日志最终的LSN
compact = 0
recover_binlog_info = 0

（1）备份时刻，立即将已经commit过的，内存中的数据页刷新到磁盘(CKPT).开始备份数据，数据文件的LSN会停留在to_lsn位置。
（2）备份时刻有可能会有其他的数据写入，已备走的数据文件就不会再发生变化了。
（3）在备份过程中，备份软件会一直监控着redo的undo，如果一旦有变化会将日志也一并备走，并记录LSN到last_lsn。
从to_lsn  ----》last_lsn 就是，备份过程中产生的数据变化.
```



### 8.3.3: 全备的恢复模拟:

```bash
模拟故障
#删除数据库
[root@localhost mysql]# rm -rf /data/mysql/*
[root@localhost mysql]# pkill mysqld

#恢复
前提：
1、被恢复的目录是空
2、被恢复的数据库的实例是关闭

将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚掉。模拟了CSR的过程
[root@localhost data]# innobackupex --apply-log /data/backup/full

#恢复方式1
[root@localhost data]# innobackupex --copy-back /data/backup/full
...
240301 14:15:48 completed OK!

[root@localhost data]# chown -R mysql.mysql /data/*
[root@localhost data]# systemctl start mysqld

#恢复方式2
[root@localhost data]#cp -a /data/backup/full/* /data/mysql/
[root@localhost data]# chown -R mysql.mysql /data/*
[root@localhost data]# systemctl start mysqld


#数据验证

[root@localhost data]# mysql -uroot -p123456

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| aa                 |
| day1               |
| db                 |
| mysql              |
| performance_schema |
| sys                |
| world_area         |
+--------------------+
8 rows in set (0.00 sec)


```



## 8.4：innobackupex增量备份(incremental)：

```bash
（1）增量备份的方式，是基于上一次备份进行增量。
（2）增量备份无法单独恢复。必须基于全备进行恢复。
（3）所有增量必须要按顺序合并到全备中。
```



### 8.4.1: 增量备份命令:

```bash
1.#删除原来的备份
[root@localhost backup]# \rm -rf /data/backup/*

2.全备(周日)
[root@localhost backup]# innobackupex --user=root --password=123456 --no-timestamp /data/backup/full
3.模拟周一数据变化
mysql> create database cs charset utf8;
Query OK, 1 row affected (0.00 sec)
mysql> use cs;
Database changed
mysql> create table t1 (id int);
Query OK, 0 rows affected (0.01 sec)
mysql> insert into t1 values(1),(2),(3);
Query OK, 3 rows affected (0.00 sec)
Records: 3  Duplicates: 0  Warnings: 0
mysql> commit;
Query OK, 0 rows affected (0.00 sec)

4.第一次增量备份（周一）
[root@localhost backup]# innobackupex --user=root --password=123456 --no-timestamp --incremental --incremental-basedir=/data/backup/full /data/backup/inc1
...
240301 17:46:10 completed OK!

#验证
[root@localhost backup]# ll /data/backup/inc1/
total 616
drwxr-x--- 2 root root    126 Mar  1 17:46 aa
-rw-r----- 1 root root    487 Mar  1 17:46 backup-my.cnf
drwxr-x--- 2 root root     73 Mar  1 17:46 cs
drwxr-x--- 2 root root     73 Mar  1 17:46 day1
drwxr-x--- 2 root root    179 Mar  1 17:46 db
-rw-r----- 1 root root    419 Mar  1 17:46 ib_buffer_pool
-rw-r----- 1 root root 573440 Mar  1 17:46 ibdata1.delta
-rw-r----- 1 root root     44 Mar  1 17:46 ibdata1.meta
drwxr-x--- 2 root root   4096 Mar  1 17:46 mysql
drwxr-x--- 2 root root   8192 Mar  1 17:46 performance_schema
drwxr-x--- 2 root root   8192 Mar  1 17:46 sys
drwxr-x--- 2 root root    274 Mar  1 17:46 world_area
-rw-r----- 1 root root     21 Mar  1 17:46 xtrabackup_binlog_info
-rw-r----- 1 root root    117 Mar  1 17:46 xtrabackup_checkpoints
-rw-r----- 1 root root    550 Mar  1 17:46 xtrabackup_info
-rw-r----- 1 root root   2560 Mar  1 17:46 xtrabackup_logfile



#模拟周二数据
mysql> create table t2(id int);
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t2 values(1),(2),(3);
Query OK, 3 rows affected (0.01 sec)
Records: 3  Duplicates: 0  Warnings: 0

mysql> commit;
Query OK, 0 rows affected (0.00 sec)

#周二增量
[root@localhost backup]# innobackupex --user=root --password=123456 --no-timestamp --incremental --incremental-basedir=/data/backup/inc1 /data/backup/inc2

[root@localhost backup]# ll /data/backup/inc2/
total 616
drwxr-x--- 2 root root    126 Mar  1 17:48 aa
-rw-r----- 1 root root    487 Mar  1 17:48 backup-my.cnf
drwxr-x--- 2 root root    126 Mar  1 17:48 cs
drwxr-x--- 2 root root     73 Mar  1 17:48 day1
drwxr-x--- 2 root root    179 Mar  1 17:48 db
-rw-r----- 1 root root    419 Mar  1 17:48 ib_buffer_pool
-rw-r----- 1 root root 573440 Mar  1 17:48 ibdata1.delta
-rw-r----- 1 root root     44 Mar  1 17:48 ibdata1.meta
drwxr-x--- 2 root root   4096 Mar  1 17:48 mysql
drwxr-x--- 2 root root   8192 Mar  1 17:48 performance_schema
drwxr-x--- 2 root root   8192 Mar  1 17:48 sys
drwxr-x--- 2 root root    274 Mar  1 17:48 world_area
-rw-r----- 1 root root     22 Mar  1 17:48 xtrabackup_binlog_info
-rw-r----- 1 root root    117 Mar  1 17:48 xtrabackup_checkpoints
-rw-r----- 1 root root    551 Mar  1 17:48 xtrabackup_info
-rw-r----- 1 root root   2560 Mar  1 17:48 xtrabackup_logfile

#模拟周三数据变化
mysql> create table t3(id int);
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t3 values(1),(2),(3);
Query OK, 3 rows affected (0.00 sec)
Records: 3  Duplicates: 0  Warnings: 0

mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> drop database cs;
Query OK, 3 rows affected (0.00 sec)

```



恢复到周三误drop之前的数据状态:

```bash
恢复思路：
1.  挂出维护页，停止当天的自动备份脚本
2.  检查备份：周日full+周一inc1+周二inc2，周三的完整二进制日志
3. 进行备份整理（细节），截取关键的二进制日志（从备份——误删除之前）
4. 测试库进行备份恢复及日志恢复
5. 应用进行测试无误，开启业务
6. 此次工作的总结
```



恢复过程

```bash
1.检查备份
[root@localhost inc2]# cat xtrabackup_binlog_info 
mysql-bin.000016	1195
2.备份整理（app-log）+合并备份（full+inc1+inc2）
(1)全备的整理
[root@localhost ~]# innobackupex --apply-log --redo-only /data/backup/full
（2）合并inc1到full中
[root@localhost ~]# innobackupex --apply-log --redo-only --incremental-dir=/data/backup/inc1 /data/backup/full
（3）合并inc2到full中
[root@localhost ~]# innobackupex --apply-log --incremental-dir=/data/backup/inc2 /data/backup/full
（4）最后一次整理全备
[root@localhost ~]# innobackupex --apply-log /data/backup/full
（4）截取周二23：00到drop之前的binlog
mysql> show binlog events in 'mysql-bin.000016';
+------------------+------+----------------+-----------+-------------+--------------------------------------------+
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info                                       |
+------------------+------+----------------+-----------+-------------+--------------------------------------------+
| mysql-bin.000016 |    4 | Format_desc    |         6 |         123 | Server ver: 5.7.25-log, Binlog ver: 4      |
| mysql-bin.000016 |  123 | Previous_gtids |         6 |         194 | e27ea2cc-9f82-11ee-9103-000c2903d870:15-23 |
| mysql-bin.000016 |  194 | Anonymous_Gtid |         6 |         259 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 |  259 | Query          |         6 |         360 | create database cs charset utf8            |
| mysql-bin.000016 |  360 | Anonymous_Gtid |         6 |         425 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 |  425 | Query          |         6 |         519 | use `cs`; create table t1 (id int)         |
| mysql-bin.000016 |  519 | Anonymous_Gtid |         6 |         584 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 |  584 | Query          |         6 |         654 | BEGIN                                      |
| mysql-bin.000016 |  654 | Table_map      |         6 |         697 | table_id: 220 (cs.t1)                      |
| mysql-bin.000016 |  697 | Write_rows     |         6 |         747 | table_id: 220 flags: STMT_END_F            |
| mysql-bin.000016 |  747 | Xid            |         6 |         778 | COMMIT /* xid=43 */                        |
| mysql-bin.000016 |  778 | Anonymous_Gtid |         6 |         843 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 |  843 | Query          |         6 |         936 | use `cs`; create table t2(id int)          |
| mysql-bin.000016 |  936 | Anonymous_Gtid |         6 |        1001 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 | 1001 | Query          |         6 |        1071 | BEGIN                                      |
| mysql-bin.000016 | 1071 | Table_map      |         6 |        1114 | table_id: 334 (cs.t2)                      |
| mysql-bin.000016 | 1114 | Write_rows     |         6 |        1164 | table_id: 334 flags: STMT_END_F            |
| mysql-bin.000016 | 1164 | Xid            |         6 |        1195 | COMMIT /* xid=72 */                        |
| mysql-bin.000016 | 1195 | Anonymous_Gtid |         6 |        1260 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 | 1260 | Query          |         6 |        1353 | use `cs`; create table t3(id int)          |
| mysql-bin.000016 | 1353 | Anonymous_Gtid |         6 |        1418 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 | 1418 | Query          |         6 |        1488 | BEGIN                                      |
| mysql-bin.000016 | 1488 | Table_map      |         6 |        1531 | table_id: 449 (cs.t3)                      |
| mysql-bin.000016 | 1531 | Write_rows     |         6 |        1581 | table_id: 449 flags: STMT_END_F            |
| mysql-bin.000016 | 1581 | Xid            |         6 |        1612 | COMMIT /* xid=103 */                       |
| mysql-bin.000016 | 1612 | Anonymous_Gtid |         6 |        1677 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'       |
| mysql-bin.000016 | 1677 | Query          |         6 |        1763 | drop database cs                           |
+------------------+------+----------------+-----------+-------------+--------------------------------------------+
27 rows in set (0.00 sec)

[root@localhost ~]# mysqlbinlog --start-position=1195 --stop-position=1677 /data/mysql-bin.000016 > /tmp/1.sql

4.进行恢复-搭建临时数据库
[root@localhost ~]#cp -a /data/backup/full/* /data/3307/
[root@localhost ~]#chown -R mysql.mysql /data/3307/
[root@localhost ~]#systemctl start mysqld3307
[root@localhost ~]# mysql -uroot -p123456 -S /tmp/mysql.sock
mysql> set sql_log_bin=0;
mysql> source /tmp/1.sql
5.验证
mysql> show tables;
+--------------+
| Tables_in_cs |
+--------------+
| t1           |
| t2           |
| t3           |
+--------------+
3 rows in set (0.00 sec)

mysql> select * from t3;
+------+
| id   |
+------+
|    1 |
|    2 |
|    3 |
+------+


```



# 九：主从复制:



## 9.1：主从复制简介:

```bash
1.1. 基于二进制日志复制的
1.2. 主库的修改操作会记录二进制日志
1.3. 从库会请求新的二进制日志并回放,最终达到主从数据同步
1.4. 主从复制核心功能:
辅助备份,处理物理损坏                   
扩展新型的架构:高可用,高性能,分布式架构等

```



### 9.1.1: 高可用架构:

```bash
1.1. 基于二进制日志复制的
1.2. 主库的修改操作会记录二进制日志
1.3. 从库会请求新的二进制日志并回放,最终达到主从数据同步
1.4. 主从复制核心功能:
辅助备份,处理物理损坏                   
扩展新型的架构:高可用,高性能,分布式架构等

```



### 9.1.2: 主从复制前提(搭建主从的过程):

```bash
## 2.1 两台以上mysql实例 ,server_id,server_uuid不同
## 2.2 主库开启二进制日志
## 2.3 专用的复制用户
## 2.4 保证主从开启之前的某个时间点,从库数据是和主库一致(补课)
## 2.5 告知从库,复制user,passwd,IP port,以及复制起点(change master to)
## 2.6 线程(三个):Dump thread  IO thread  SQL thread 开启(start slave)
```



## 9.2: 主从复制搭建:

### 9.2.1: 数据初始化过程:

```bash
[root@localhost data]# rm -rf /data/3307/data/*

#初始化3307
[root@localhost data]# mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --datadir=/data/3307/data

[root@localhost data]#mkdir /data/3308/data
[root@localhost data]#mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --datadir=/data/3308/data

#mysql.conf配置
[root@localhost 3307]# cat /data/3307/my.cnf 
[mysqld]
basedir=/app/mysql
datadir=/data/3307/data
port=3307
log_error=/data/3307/log/mysql.log
socket=/data/3307/mysql.sock
server_id=7
log_bin=/data/3307/data/mysql-bin

[root@localhost 3307]# cat /data/3308/my.cnf 
[mysqld]
basedir=/app/mysql
datadir=/data/3308/data
port=3308
log_error=/data/3308/log/mysql.log
socket=/data/3308/mysql.sock
server_id=8
log_bin=/data/3308/data/mysql-bin

#启动文件配置
[root@localhost 3307]# cat /etc/systemd/system/mysqld3307.service 
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf
LimitNOFILE = 65536
LimitNPROC = 65536

[root@localhost 3307]# cat /etc/systemd/system/mysqld3308.service 
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf
LimitNOFILE = 65536
LimitNPROC = 65536

[root@localhost 3307]#systemctl start mysqld3307
[root@localhost 3307]#systemctl start mysqld3308
[root@localhost backup]# cat full.sql | grep mysql-bin.000*
-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=449;


#主库中创建复制用户
[root@db01 3307]# mysql -S /data/3307/mysql.sock 
db01 [(none)]>grant replication slave on *.* to repl@'192.168.150.%' identified by '123';
db01 [(none)]>select user,host from mysql.user;

#备份主库并恢复到从库
[root@db01 3307]# mysqldump -S /data/3307/mysql.sock -A --master-data=2 --single-transaction  -R --triggers >/backup/full.sql
-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=449;
[root@db01 3307]# mysql -S /data/3308/mysql.sock
db01 [(none)]>source /backup/full.sql
```



### 9.2.2：从库关键复制信息:

```shell
mysql>  help change master to
CHANGE MASTER TO
  MASTER_HOST='192.168.150.141',
  MASTER_USER='repl',
  MASTER_PASSWORD='123',
  MASTER_PORT=3307,
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=449,
  MASTER_CONNECT_RETRY=10;

#开启主从专用线程
mysql> start slave;
Query OK, 0 rows affected (0.00 sec)

#检查复制状态
mysql> show slave status\G;
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes



```



### 9.2.3：相关信息监控:

```bash
#相关信息监控
#主库相关信息
                  Master_Host: 192.168.150.141		#IP地址
                  Master_User: repl					#复制用户
                  Master_Port: 3307					#复制端口
              Master_Log_File: mysql-bin.000002		#复制二进制日志
          Read_Master_Log_Pos: 154					#复制ID号

#从库中继日志的应用状态
               Relay_Log_File: localhost-relay-bin.000004
                Relay_Log_Pos: 367

#从库线程的状态
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
            Last_IO_Errno: 0
             Last_IO_Error: 
              Last_SQL_Errno: 0
              Last_SQL_Error: 
            
#过滤复制有关的状态          
              Replicate_Do_DB:  #指定复制哪个库 白名单
          Replicate_Ignore_DB:   #从库选项，匹配的数据不进行复制
           Replicate_Do_Table: 	#从库选项，匹配的表进行复制
       Replicate_Ignore_Table:  #从库选项，匹配的表不进行复制
      Replicate_Wild_Do_Table:  #从库选项，匹配的表进行复制，可以使用通配符
  Replicate_Wild_Ignore_Table:  #从库选项，匹配的表不复制，可以使用通配符
  
#主从延时相关状态-非人为
        Seconds_Behind_Master: 0

#延时从库有关的状态-人为
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
          
#GTID复制有关的状态
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
```



### 9.2.4：主从复制原理:

```bash
1.change master to 时，ip pot user password binlog position写入到master.info进行记录
2. start slave 时，从库会启动IO线程和SQL线程
3.IO_T，读取master.info信息，获取主库信息连接主库
4. 主库会生成一个准备binlog DUMP线程，来响应从库
5. IO_T根据master.info记录的binlog文件名和position号，请求主库DUMP最新日志
6. DUMP线程检查主库的binlog日志，如果有新的，TP(传送)给从从库的IO_T
7. IO_T将收到的日志存储到了TCP/IP 缓存，立即返回ACK给主库 ，主库工作完成
8.IO_T将缓存中的数据，存储到relay-log日志文件,更新master.info文件binlog 文件名和postion，IO_T工作完成
9.SQL_T读取relay-log.info文件，获取到上次执行到的relay-log的位置，作为起点，回放relay-log
10.SQL_T回放完成之后，会更新relay-log.info文件。
11. relay-log会有自动清理的功能。
细节：
1.主库一旦有新的日志生成，会发送“信号”给binlog dump ，IO线程再请求
```



### 9.2.5：主从复制涉及到的文件:

```bash

#主从复制过程中涉及到的文件
主库:
	mysql-bin.00001: 二进制日志(binlog)
从库:
	localhost-relay-bin.000001 中继日志(relaylog)文件
	master.info(主库信息)
	relay-log-info:中继日志信息
	
#主从复制过程中涉及到的线程
主库:
	binlog_dump_thread: dump
从库:
	slave_IO_THread: IO
	slave_SQL_thread: SQL
	
#画图说明主从复制原理

```

![](/images/posts/10_mysql/15.png)



![](/images/posts/10_mysql/16.png)



### 9.2.6：主从复制故障分析:

#### 5.2.6.1: IO故障:

```bash
(1) 用户 密码  IP  port
Last_IO_Error: error reconnecting to master 'repl@10.0.0.51:3307' - retry-time: 10  retries: 7
[root@db01 ~]# mysql -urepl  -p123333  -h 10.0.0.51 -P 3307
ERROR 1045 (28000): Access denied for user 'repl'@'db01' (using password: YES)

原因:
密码错误 
用户错误 
skip_name_resolve
地址错误
端口
```



![](/images/posts/10_mysql/17.png)



```bash
#处理方法
stop  slave  
reset slave all 
change master to 
start slave
```



**主库连接数上线,或者是主库太繁忙**



```
show slave  staus \G 
Last_IO_Errno: 1040
Last_IO_Error: error reconnecting to master 'repl@10.0.0.51:3307' - retry-time: 10  retries: 7
处理思路:
拿复制用户,手工连接一下

[root@db01 ~]# mysql -urepl -p123 -h 10.0.0.51 -P 3307 
mysql: [Warning] Using a password on the command line interface can be insecure.
ERROR 1040 (HY000): Too many connections
处理方法:
db01 [(none)]>set global max_connections=300;

(3) 防火墙,网络不通
```



**请求二进制日志**



```bash
#主库缺失日志
#从库方面,二进制日志位置点不对
Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: 'could not find next log; the first event 'mysql-bin.000001' at 154, the last event read from '/data/3307/data/mysql-bin.000002' at 154, the last byte read from '/data/3307/data/mysql-bin.000002' at 154.'
```



![](/images/posts/10_mysql/18.png)



```bash
#注意: 在主从复制环境中,严令禁止主库中reset master; 可以选择expire 进行定期清理主库二进制日志
解决方案:
重新构建主从
```



#### 5.2.6.2: SQL线程故障:

**SQL线程功能:**

```bash
(1)读写relay-log.info 
(2)relay-log损坏,断节,找不到
(3)接收到的SQL无法执行
```



**导致SQL线程故障原因分析:**

```bash
1. 版本差异，参数设定不同，比如：数据类型的差异，SQL_MODE影响
2.要创建的数据库对象,已经存在
3.要删除或修改的对象不存在  
4.DML语句不符合表定义及约束时.  
归根揭底的原因都是由于从库发生了写入操作.
Last_SQL_Error: Error 'Can't create database 'db'; database exists' on query. Default database: 'db'. Query: 'create database db'
```



**处理方法:(以从库为核心的处理方案)**

```bash
方法一：
stop slave; 
set global sql_slave_skip_counter = 1;
#将同步指针向下移动一个，如果多次不同步，可以重复操作。
start slave;
方法二：
/etc/my.cnf
slave-skip-errors = 1032,1062,1007
常见错误代码:
1007:对象已存在
1032:无法执行DML
1062:主键冲突,或约束冲突

但是，以上操作有时是有风险的，最安全的做法就是重新构建主从。把握一个原则,一切以主库为主.
```



**一劳永逸的方法:**

```bash
(1) 可以设置从库只读.
db01 [(none)]>show variables like '%read_only%';
注意：
只会影响到普通用户，对管理员用户无效。
(2)加中间件
读写分离。
```



**主从延时监控及原因:**

```bash
主库做了修改操作,从库比较长时间才能追上.
```



**外在因素:**

```bash
网络 
主从硬件差异较大
版本差异
参数因素
```



**主库:**

```bash
(1) 二进制日志写入不及时
[rep]>select @@sync_binlog;
(2) CR的主从复制中,binlog_dump线程,事件为单元,串行传送二进制日志(5.6 5.5)

1. 主库并发事务量大,主库可以并行,传送时是串行
2. 主库发生了大事务,由于是串行传送,会产生阻塞后续的事务.

解决方案:
1. 5.6 开始,开启GTID,实现了GC(group commit)机制,可以并行传输日志给从库IO
2. 5.7 开始,不开启GTID,会自动维护匿名的GTID,也能实现GC,我们建议还是认为开启GTID
3. 大事务拆成多个小事务,可以有效的减少主从延时.
```



**从库:**

```bash
SQL线程导致的主从延时
在CR复制情况下: 从库默认情况下只有一个SQL,只能串行回放事务SQL
1. 主库如果并发事务量较大,从库只能串行回放
2. 主库发生了大事务,会阻塞后续的所有的事务的运行

解决方案:
1. 5.6 版本开启GTID之后,加入了SQL多线程的特性,但是只能针对不同库(database)下的事务进行并发回放.
2. 5.7 版本开始GTID之后,在SQL方面,提供了基于逻辑时钟(logical_clock),binlog加入了seq_no机制,
真正实现了基于事务级别的并发回放,这种技术我们把它称之为MTS(enhanced multi-threaded slave).
3. 大事务拆成多个小事务,可以有效的减少主从延时.
[https://dev.mysql.com/worklog/task/?id=6314]
```



## 9.3: 延时从库:

```bash
#介绍
是我们认为配置的一种特殊从库.人为配置从库和主库延时N小时.
#为什么要延时从
数据库故障?
物理损坏
主从复制非常擅长解决物理损坏.
逻辑损坏
普通主从复制没办法解决逻辑损坏

#配置延时从库
SQL线程延时:数据已经写入relaylog中了,SQL线程"慢点"运行
一般企业建议3-6小时,具体看公司运维人员对于故障的反应时间

mysql>stop slave;
mysql>CHANGE MASTER TO MASTER_DELAY = 300;
mysql>start slave;
mysql> show slave status \G
SQL_Delay: 300
SQL_Remaining_Delay: NULL

```



### 9.3.1：延时从库应用:

```bash
1主1从,从库延时5分钟,主库误删除1个库
1. 5分钟之内 侦测到误删除操作
2. 停从库SQL线程
3. 截取relaylog
起点 :停止SQL线程时,relay最后应用位置
终点:误删除之前的position(GTID)
4. 恢复截取的日志到从库
5. 从库身份解除,替代主库工作
```



### 9.3.2: 故障模拟及恢复:

```bash
1.主库数据操作
db01 [(none)]>create database relay charset utf8;
db01 [(none)]>use relay
db01 [relay]>create table t1 (id int);
db01 [relay]>insert into t1 values(1);
db01 [relay]>drop database relay;

2. 停止从库SQL线程
stop slave sql_thread;

3.找relaylog的截取起点和终点
起点：
Relay_Log_File: localhost-relay-bin.000002
Relay_Log_Pos: 320
终点：
mysql> show relaylog events in 'localhost-relay-bin.000002'
| localhost-relay-bin.000002 | 884 | Xid            |         7 |         749 | COMMIT /* xid=47 */                   |
| localhost-relay-bin.000002 | 915 | Anonymous_Gtid |         7 |         814 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'

[root@localhost ~]# mysqlbinlog --start-position=320 --stop-position=915 /data/3308/data/localhost-relay-bin.000002 > /tmp/relay.sql

4.从库恢复relaylog
mysql> source /tmp/relay.sql
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| relay              |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

mysql> use relay;
Database changed
mysql> show tables;
+-----------------+
| Tables_in_relay |
+-----------------+
| t1              |
+-----------------+
1 row in set (0.00 sec)

mysql> select * from t1;
+------+
| id   |
+------+
|    1 |
+------+
1 row in set (0.00 sec)

5.从库身份解除
db01 [relay]>stop slave;
db01 [relay]>reset slave all
```

### 9.3.3: 半同步复制:

```bash
#解决主从数据一致性问题

#半同步复制工作原理的变化
1. 主库执行新的事务,commit时,更新 show master  status\G ,触发一个信号给
2. binlog dump 接收到主库的 show master status\G信息,通知从库日志更新了
3. 从库IO线程请求新的二进制日志事件
4. 主库会通过dump线程传送新的日志事件,给从库IO线程
5. 从库IO线程接收到binlog日志,当日志写入到磁盘上的relaylog文件时,给主库ACK_receiver线程
6. ACK_receiver线程触发一个事件,告诉主库commit可以成功了
7. 如果ACK达到了我们预设值的超时时间,半同步复制会切换为原始的异步复制.

#配置半同步复制
加载插件
主:
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
从:
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
查看是否加载成功:
show plugins;
启动:
主:
SET GLOBAL rpl_semi_sync_master_enabled = 1;
从:
SET GLOBAL rpl_semi_sync_slave_enabled = 1;
重启从库上的IO线程
STOP SLAVE IO_THREAD;
START SLAVE IO_THREAD;
查看是否在运行
主:
show status like 'Rpl_semi_sync_master_status';
从:
show status like 'Rpl_semi_sync_slave_status';

```



## 9.4： 过滤复制:

### 9.4.1: 说明:

```bash
#主库
show master status;
Binlog_Do_DB
Binlog_Ignore_DB 

#从库
show slave status\G
Replicate_Do_DB: 
Replicate_Ignore_DB: 
```



### 9.4.2：实现过程:

```bash
[root@localhost backup]# mysqldump -S /data/3307/mysql.sock -A --master-data=2 --single-transaction -R --triggers >/data/backup/full.sql

[root@localhost backup]# vim /data/backup/full.sql

-- CHANGE MASTER TO MASTER_LOG_FILE='c', MASTER_LOG_POS=909;

[root@localhost backup]# mysql -uroot -p -S /data/3308/mysql.sock
mysql> source /data/backup/full.sql

mysql>CHANGE MASTER TO
MASTER_HOST='192.168.150.141',
MASTER_USER='repl',
MASTER_PASSWORD='123',
MASTER_PORT=3307,
MASTER_LOG_FILE='mysql-bin.000003',
MASTER_LOG_POS=4098,
MASTER_CONNECT_RETRY=10;
mysql>start slave;

#主库：
Master [(none)]>create database word;
Query OK, 1 row affected (0.00 sec)
Master [(none)]>create database ppt;
Query OK, 1 row affected (0.00 sec)
Master [(none)]>create database excel;
Query OK, 1 row affected (0.01 sec)
```



## 9.5: GTID复制:

### 9.5.1: GTID介绍:

```bash
GTID(Global Transaction ID)是对于一个已提交事务的唯一编号，并且是一个全局(主从复制)唯一的编号。
它的官方定义如下：
GTID = source_id ：transaction_id
7E11FA47-31CA-19E1-9E56-C43AA21293967:29
什么是sever_uuid，和Server-id 区别？
核心特性: 全局唯一,具备幂等性

#GIID核心参数
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1

gtid-mode=on                        --启用gtid类型，否则就是普通的复制架构
enforce-gtid-consistency=true               --强制GTID的一致性
log-slave-updates=1                 --slave更新是否记入日志
```



### 9.5.2：准备配置文件:

```bash
主库db01：
cat > /etc/my.cnf <<EOF
[mysqld]
basedir=/data/mysql/
datadir=/data/mysql/data
socket=/tmp/mysql.sock
server_id=51
port=3306
secure-file-priv=/tmp
autocommit=0
log_bin=/data/binlog/mysql-bin
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
[mysql]
prompt=db01 [\\d]>
EOF

slave1(db02)：
cat > /etc/my.cnf <<EOF
[mysqld]
basedir=/data/mysql
datadir=/data/mysql/data
socket=/tmp/mysql.sock
server_id=52
port=3306
secure-file-priv=/tmp
autocommit=0
log_bin=/data/binlog/mysql-bin
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
[mysql]
prompt=db02 [\\d]>
EOF

slave2(db03)：
cat > /etc/my.cnf <<EOF
[mysqld]
basedir=/data/mysql
datadir=/data/mysql/data
socket=/tmp/mysql.sock
server_id=53
port=3306
secure-file-priv=/tmp
autocommit=0
log_bin=/data/binlog/mysql-bin
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
[mysql]
prompt=db03 [\\d]>
EOF
```



### 9.5.3: 初始化数据库:

```bash
#mysqld --initialize-insecure --user=mysql --basedir=/data/mysql  --datadir=/data/mysql/data 


#启动数据库
systemctl start mysqld
```



### 9.5.4: 构建主从:

```bash
master:51
slave:52,53

51:
grant replication slave  on *.* to repl@'10.0.0.%' identified by '123';

52\53:
change master to 
master_host='10.0.0.51',
master_user='repl',
master_password='123' ,
MASTER_AUTO_POSITION=1;

start slave;

```



### 9.5.5: GTID从库误写入操作处理:

```bash
查看监控信息:
Last_SQL_Error: Error 'Can't create database 'oldboy'; database exists' on query. Default database: 'oldboy'. Query: 'create database oldboy'

Retrieved_Gtid_Set: 71bfa52e-4aae-11e9-ab8c-000c293b577e:1-3
Executed_Gtid_Set:  71bfa52e-4aae-11e9-ab8c-000c293b577e:1-2,
7ca4a2b7-4aae-11e9-859d-000c298720f6:1

注入空事物的方法：

stop slave;
set gtid_next='99279e1e-61b7-11e9-a9fc-000c2928f5dd:3';
begin;commit;
set gtid_next='AUTOMATIC';
    
这里的xxxxx:N 也就是你的slave sql thread报错的GTID，或者说是你想要跳过的GTID。
最好的解决方案：重新构建主从环境
```





### 9.5.6: GTID复制和普通复制的区别:

```bash
CHANGE MASTER TO
MASTER_HOST='10.0.0.51',
MASTER_USER='repl',
MASTER_PASSWORD='123',
MASTER_PORT=3307,
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=444,
MASTER_CONNECT_RETRY=10;

change master to 
master_host='10.0.0.51',
master_user='repl',
master_password='123' ,
MASTER_AUTO_POSITION=1;
start slave;

（0）在主从复制环境中，主库发生过的事务，在全局都是由唯一GTID记录的，更方便Failover
（1）额外功能参数（3个）
（2）change master to 的时候不再需要binlog 文件名和position号,MASTER_AUTO_POSITION=1;
（3）在复制过程中，从库不再依赖master.info文件，而是直接读取最后一个relaylog的 GTID号
（4） mysqldump备份时，默认会将备份中包含的事务操作，以以下方式
    SET @@GLOBAL.GTID_PURGED='8c49d7ec-7e78-11e8-9638-000c29ca725d:1';
    告诉从库，我的备份中已经有以上事务，你就不用运行了，直接从下一个GTID开始请求binlog就行。
```



# 10: MHA高可用技术:

## 10.1: 主从复制架构演变:

```bash
1.#基本结构
（1）一主一从
（2）一主多从
（3）多级主从
（4）双主
（5）循环复制

2.#高性能架构
读写分离架构(读性能较高)
代码级别
MySQL proxy (Atlas,mysql router,proxySQL(percona),maxscale)、
amoeba(taobao)
xx-dbproxy等。
分布式架构(读写性能都提高):
分库分表——cobar--->TDDL(头都大了),DRDS
Mycat--->DBLE自主研发等。
NewSQL-->TiDB

3.#高可用架构
（3）单活:MMM架构——mysql-mmm（google）
（4）单活:MHA架构——mysql-master-ha（日本DeNa）,T-MHA
（5）多活:MGR ——5.7 新特性 MySQL Group replication(5.7.17) --->Innodb Cluster  
（6）多活:MariaDB Galera Cluster架构,(PXC)Percona XtraDB Cluster、MySQL Cluster(Oracle rac)架构
```



### 10.1.1: 架构工作原理:

```bash
主库宕机处理过程
1. 监控节点 (通过配置文件获取所有节点信息)
   系统,网络,SSH连接性
   主从状态,重点是主库

2. 选主
(1) 如果判断从库(position或者GTID),数据有差异,最接近于Master的slave,成为备选主
(2) 如果判断从库(position或者GTID),数据一致,按照配置文件顺序,选主.
(3) 如果设定有权重(candidate_master=1),按照权重强制指定备选主.
    1. 默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重,也会失效.
    2. 如果check_repl_delay=0的化,即使落后很多日志,也强制选择其为备选主
3. 数据补偿
(1) 当SSH能连接,从库对比主库GTID 或者position号,立即将二进制日志保存至各个从节点并且应用(save_binary_logs )
(2) 当SSH不能连接, 对比从库之间的relaylog的差异(apply_diff_relay_logs) 
4. Failover
将备选主进行身份切换,对外提供服务
其余从库和新主库确认新的主从关系
5. 应用透明(VIP)
6. 故障切换通知(send_reprt)
7. 二次数据补偿(binlog_server)
8. 自愈自治(待开发...)



#架构介绍
1主2从，master：db01   slave：db02   db03 ）：
MHA 高可用方案软件构成
Manager软件：选择一个从节点安装
Node软件：所有节点都要安装


```



### 10.1.2：MHA软件构成:

```bash
Manager工具包主要包括以下几个工具：
masterha_manger             启动MHA 
masterha_check_ssh      检查MHA的SSH配置状况 
masterha_check_repl         检查MySQL复制状况 
masterha_master_monitor     检测master是否宕机 
masterha_check_status       检测当前MHA运行状态 
masterha_master_switch  控制故障转移（自动或者手动）
masterha_conf_host      添加或删除配置的server信息

Node工具包主要包括以下几个工具：
这些工具通常由MHA Manager的脚本触发，无需人为操作
save_binary_logs            保存和复制master的二进制日志 
apply_diff_relay_logs       识别差异的中继日志事件并将其差异的事件应用于其他的
purge_relay_logs            清除中继日志（不会阻塞SQL线程）
```



### 10.1.3: MHA环境搭建:

```bash
1.主库: 141    node 
从库: 
142      node
143     node    manager

2.配置关键程序软连接:
[root@localhost ~]# ln -s /app/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog
[root@localhost ~]# ln -s /app/mysql/bin/mysql /usr/bin/mysql

3.配置各节点互信:
db01
[root@localhost ~]#rm -rf /root.ssh
[root@localhost ~]# ssh-keygen
[root@localhost ~]#cd /root/.ssh
[root@localhost ~]#mv id_rsa.pub authorized_keys
[root@localhost ~]#scp  -r  /root/.ssh  192.168.150.142:/root
[root@localhost ~]#scp  -r  /root/.ssh  192.168.150.143:/root
#各节点验证
db01
[root@localhost ~]# ssh 192.168.150.141 date
[root@localhost ~]# ssh 192.168.150.142 date
[root@localhost ~]# ssh 192.168.150.143 date
db02
[root@localhost ~]# ssh 192.168.150.141 date
[root@localhost ~]# ssh 192.168.150.142 date
[root@localhost ~]# ssh 192.168.150.143 date
db03
[root@localhost ~]# ssh 192.168.150.141 date
[root@localhost ~]# ssh 192.168.150.142 date
[root@localhost ~]# ssh 192.168.150.143 

4.下载mha软件
mha官网：https://code.google.com/archive/p/mysql-master-ha/
github下载地址：https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads

5.所有节点安装Node软件依赖包
[root@localhost ~]# yum install perl-DBD-MySQL -y
[root@localhost ~]#wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm
[root@localhost ~]#rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm

6.在主库中创建mha需要的用户
mysql>  grant all privileges on *.* to mha@'192.168.150.%' identified by 'mha';

7.Manager软件安装
[root@localhost ~]#yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes
[root@localhost ~]#wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm
[root@localhost ~]#rpm -ivh mha4mysql-manager-0.58-0.el7.centos.noarch.rpm

8.配置文件准备db03主节点
#创建配置文件目录
[root@localhost ~]#mkdir /etc/mha
#创建日志目录
[root@localhost ~]#mkdir -p /var/log/mha/app1
#编辑mha配置文件
[root@localhost ~]# cat /etc/mha/app1.cnf 
[server default]
manager_log=/var/log/mha/app1/manager
manager_workdir=/var/log/mha/app1
master_binlog_dir=/data
user=mha
password=mha
ping_interval=2
repl_password=123
repl_user=repl
ssh_user=root
[server1]
hostname=192.168.150.141
port=3306
[server2]
hostname=192.168.150.142
port=3306
[server3]
hostname=192.168.150.143
port=3306


9.状态检查
#互信检查
[root@localhost ~]# masterha_check_ssh  --conf=/etc/mha/app1.cnf 
Thu Mar 14 21:15:19 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Thu Mar 14 21:15:19 2024 - [info] Reading application default configuration from /etc/mha/app1.cnf..
Thu Mar 14 21:15:19 2024 - [info] Reading server configuration from /etc/mha/app1.cnf..
Thu Mar 14 21:15:19 2024 - [info] Starting SSH connection tests..
Thu Mar 14 21:15:20 2024 - [debug] 
Thu Mar 14 21:15:19 2024 - [debug]  Connecting via SSH from root@192.168.150.141(192.168.150.141:22) to root@192.168.150.142(192.168.150.142:22)..
Thu Mar 14 21:15:19 2024 - [debug]   ok.
Thu Mar 14 21:15:19 2024 - [debug]  Connecting via SSH from root@192.168.150.141(192.168.150.141:22) to root@192.168.150.143(192.168.150.143:22)..
Thu Mar 14 21:15:20 2024 - [debug]   ok.
Thu Mar 14 21:15:22 2024 - [debug] 
Thu Mar 14 21:15:20 2024 - [debug]  Connecting via SSH from root@192.168.150.143(192.168.150.143:22) to root@192.168.150.141(192.168.150.141:22)..
Thu Mar 14 21:15:20 2024 - [debug]   ok.
Thu Mar 14 21:15:20 2024 - [debug]  Connecting via SSH from root@192.168.150.143(192.168.150.143:22) to root@192.168.150.142(192.168.150.142:22)..
Thu Mar 14 21:15:21 2024 - [debug]   ok.
Thu Mar 14 21:15:31 2024 - [debug] 
Thu Mar 14 21:15:20 2024 - [debug]  Connecting via SSH from root@192.168.150.142(192.168.150.142:22) to root@192.168.150.141(192.168.150.141:22)..
Thu Mar 14 21:15:30 2024 - [debug]   ok.
Thu Mar 14 21:15:30 2024 - [debug]  Connecting via SSH from root@192.168.150.142(192.168.150.142:22) to root@192.168.150.143(192.168.150.143:22)..
Thu Mar 14 21:15:30 2024 - [debug]   ok.
Thu Mar 14 21:15:31 2024 - [info] All SSH connection tests passed successfully.
[root@localhost ~]#  masterha_check_repl  --conf=/etc/mha/app1.cnf 
Thu Mar 14 21:15:46 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.
Thu Mar 14 21:15:46 2024 - [info] Reading application default configuration from /etc/mha/app1.cnf..
Thu Mar 14 21:15:46 2024 - [info] Reading server configuration from /etc/mha/app1.cnf..
Thu Mar 14 21:15:46 2024 - [info] MHA::MasterMonitor version 0.58.
Thu Mar 14 21:15:47 2024 - [info] GTID failover mode = 0
Thu Mar 14 21:15:47 2024 - [info] Dead Servers:
Thu Mar 14 21:15:47 2024 - [info] Alive Servers:
Thu Mar 14 21:15:47 2024 - [info]   192.168.150.141(192.168.150.141:3306)
Thu Mar 14 21:15:47 2024 - [info]   192.168.150.142(192.168.150.142:3306)
Thu Mar 14 21:15:47 2024 - [info]   192.168.150.143(192.168.150.143:3306)
Thu Mar 14 21:15:47 2024 - [info] Alive Slaves:
Thu Mar 14 21:15:47 2024 - [info]   192.168.150.142(192.168.150.142:3306)  Version=5.7.25-log (oldest major version between slaves) log-bin:enabled
Thu Mar 14 21:15:47 2024 - [info]     Replicating from 192.168.150.141(192.168.150.141:3306)
Thu Mar 14 21:15:47 2024 - [info]   192.168.150.143(192.168.150.143:3306)  Version=5.7.25-log (oldest major version between slaves) log-bin:enabled
Thu Mar 14 21:15:47 2024 - [info]     Replicating from 192.168.150.141(192.168.150.141:3306)
Thu Mar 14 21:15:47 2024 - [info] Current Alive Master: 192.168.150.141(192.168.150.141:3306)
Thu Mar 14 21:15:47 2024 - [info] Checking slave configurations..
Thu Mar 14 21:15:47 2024 - [info]  read_only=1 is not set on slave 192.168.150.142(192.168.150.142:3306).
Thu Mar 14 21:15:47 2024 - [warning]  relay_log_purge=0 is not set on slave 192.168.150.142(192.168.150.142:3306).
Thu Mar 14 21:15:47 2024 - [info]  read_only=1 is not set on slave 192.168.150.143(192.168.150.143:3306).
Thu Mar 14 21:15:47 2024 - [warning]  relay_log_purge=0 is not set on slave 192.168.150.143(192.168.150.143:3306).
Thu Mar 14 21:15:47 2024 - [info] Checking replication filtering settings..
Thu Mar 14 21:15:47 2024 - [info]  binlog_do_db= , binlog_ignore_db= 
Thu Mar 14 21:15:47 2024 - [info]  Replication filtering check ok.
Thu Mar 14 21:15:47 2024 - [info] GTID (with auto-pos) is not supported
Thu Mar 14 21:15:47 2024 - [info] Starting SSH connection tests..
Thu Mar 14 21:15:48 2024 - [info] All SSH connection tests passed successfully.
Thu Mar 14 21:15:48 2024 - [info] Checking MHA Node version..
Thu Mar 14 21:15:48 2024 - [info]  Version check ok.
Thu Mar 14 21:15:48 2024 - [info] Checking SSH publickey authentication settings on the current master..
Thu Mar 14 21:15:49 2024 - [info] HealthCheck: SSH to 192.168.150.141 is reachable.
Thu Mar 14 21:15:49 2024 - [info] Master MHA Node version is 0.58.
Thu Mar 14 21:15:49 2024 - [info] Checking recovery script configurations on 192.168.150.141(192.168.150.141:3306)..
Thu Mar 14 21:15:49 2024 - [info]   Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/data --output_file=/var/tmp/save_binary_logs_test --manager_version=0.58 --start_file=mysql-bin.000002 
Thu Mar 14 21:15:49 2024 - [info]   Connecting to root@192.168.150.141(192.168.150.141:22).. 
  Creating /var/tmp if not exists..    ok.
  Checking output directory is accessible or not..
   ok.
  Binlog found at /data, up to mysql-bin.000002
Thu Mar 14 21:15:49 2024 - [info] Binlog setting check done.
Thu Mar 14 21:15:49 2024 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..
Thu Mar 14 21:15:49 2024 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='mha' --slave_host=192.168.150.142 --slave_ip=192.168.150.142 --slave_port=3306 --workdir=/var/tmp --target_version=5.7.25-log --manager_version=0.58 --relay_log_info=/data/mysql/relay-log.info  --relay_dir=/data/mysql/  --slave_pass=xxx
Thu Mar 14 21:15:49 2024 - [info]   Connecting to root@192.168.150.142(192.168.150.142:22).. 
  Checking slave recovery environment settings..
    Opening /data/mysql/relay-log.info ... ok.
    Relay log found at /data/mysql, up to localhost-relay-bin.000002
    Temporary relay log file is /data/mysql/localhost-relay-bin.000002
    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.
    Testing mysql connection and privileges..
mysql: [Warning] Using a password on the command line interface can be insecure.
 done.
    Testing mysqlbinlog output.. done.
    Cleaning up test file(s).. done.
Thu Mar 14 21:15:49 2024 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='mha' --slave_host=192.168.150.143 --slave_ip=192.168.150.143 --slave_port=3306 --workdir=/var/tmp --target_version=5.7.25-log --manager_version=0.58 --relay_log_info=/data/mysql/relay-log.info  --relay_dir=/data/mysql/  --slave_pass=xxx
Thu Mar 14 21:15:49 2024 - [info]   Connecting to root@192.168.150.143(192.168.150.143:22).. 
  Checking slave recovery environment settings..
    Opening /data/mysql/relay-log.info ... ok.
    Relay log found at /data/mysql, up to localhost-relay-bin.000002
    Temporary relay log file is /data/mysql/localhost-relay-bin.000002
    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.
    Testing mysql connection and privileges..
mysql: [Warning] Using a password on the command line interface can be insecure.
 done.
    Testing mysqlbinlog output.. done.
    Cleaning up test file(s).. done.
Thu Mar 14 21:15:50 2024 - [info] Slaves settings check done.
Thu Mar 14 21:15:50 2024 - [info] 
192.168.150.141(192.168.150.141:3306) (current master)
 +--192.168.150.142(192.168.150.142:3306)
 +--192.168.150.143(192.168.150.143:3306)

Thu Mar 14 21:15:50 2024 - [info] Checking replication health on 192.168.150.142..
Thu Mar 14 21:15:50 2024 - [info]  ok.
Thu Mar 14 21:15:50 2024 - [info] Checking replication health on 192.168.150.143..
Thu Mar 14 21:15:50 2024 - [info]  ok.
Thu Mar 14 21:15:50 2024 - [warning] master_ip_failover_script is not defined.
Thu Mar 14 21:15:50 2024 - [warning] shutdown_script is not defined.
Thu Mar 14 21:15:50 2024 - [info] Got exit code 0 (Not master dead).

MySQL Replication Health is OK.

10.开启MHA（db03）
[root@localhost ~]# nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  < /dev/null> /var/log/mha/app1/manager.log 2>&1 &

11.查看MHA状态
[root@localhost app1]# mysql -umha -pmha -h 192.168.150.141 -e "show variables like 'server_id'"
mysql: [Warning] Using a password on the command line interface can be insecure.
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 6     |
+---------------+-------+
[root@localhost app1]# mysql -umha -pmha -h 192.168.150.142 -e "show variables like 'server_id'"
mysql: [Warning] Using a password on the command line interface can be insecure.
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 7     |
+---------------+-------+
[root@localhost app1]# mysql -umha -pmha -h 192.168.150.143 -e "show variables like 'server_id'"
mysql: [Warning] Using a password on the command line interface can be insecure.
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 8     |
+---------------+-------+

```



### 10.1.4：故障模拟处理：

```bash
#停掉主库
[root@localhost ~]# systemctl stop mysqld

#观察manager  日志 tail -f /var/log/mha/app1/manager
末尾必须显示successfully，才算正常切换成功。       
Started automated(non-interactive) failover.
The latest slave 192.168.150.142(192.168.150.142:3306) has all relay logs for recovery.
Selected 192.168.150.142(192.168.150.142:3306) as a new master.
192.168.150.142(192.168.150.142:3306): OK: Applying all logs succeeded.
192.168.150.143(192.168.150.143:3306): This host has the latest relay log events.
Generating relay diff files from the latest slave succeeded.
192.168.150.143(192.168.150.143:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.150.142(192.168.150.142:3306)
192.168.150.142(192.168.150.142:3306): Resetting slave info succeeded.
Master failover to 192.168.150.142(192.168.150.142:3306) completed successfully.

#查看从
mysql> show slave status \G;
                  Master_Host: 192.168.150.142
                  Master_User: repl
                  Master_Port: 3306


#修复主库

[root@localhost ~]# systemctl start mysqld
[root@localhost ~]# mysql
mysql> CHANGE MASTER TO
MASTER_HOST='192.168.150.142',
MASTER_PORT=3306,
MASTER_LOG_FILE='mysql-bin.000002',
MASTER_LOG_POS=1121,
MASTER_USER='repl',
MASTER_PASSWORD='123';

#修改配置文件
[root@localhost app1]# vim /etc/mha/app1.cnf
[server1]
hostname=192.168.150.141
port=3306


#启动MHA
[root@localhost app1]# nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/mha/app1/manager.log 2>&1 &

```



### 10.1.5：Manager额外参数介绍:

```bash
说明：
主库宕机谁来接管？
1. 所有从节点日志都是一致的，默认会以配置文件的顺序去选择一个新主。
2. 从节点日志不一致，自动选择最接近于主库的从库
3. 如果对于某节点设定了权重（candidate_master=1），权重节点会优先选择。
但是此节点日志量落后主库100M日志的话，也不会被选择。可以配合check_repl_delay=0，关闭日志量的检查，强制选择候选节点。

(1)  ping_interval=1
#设置监控主库，发送ping包的时间间隔，尝试三次没有回应的时候自动进行failover
(2) candidate_master=1
#设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave
(3)check_repl_delay=0
#默认情况下如果一个slave落后master 100M的relay logs的话，
MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master
```



### 10.1.6: MHA的VIP功能：

```bash
[root@localhost ~]# cat /usr/local/bin/master_ip_failover 
#!/usr/bin/env perl
use strict;
use warnings FATAL => 'all';
 
use Getopt::Long;
 
my (
$command, $ssh_user, $orig_master_host, $orig_master_ip,
$orig_master_port, $new_master_host, $new_master_ip, $new_master_port
);
#############################添加内容部分#########################################
my $vip = '192.168.150.88';									#指定vip的地址
my $brdc = '192.168.150.255';							#指定vip的广播地址
my $ifdev = 'ens33';										#指定vip绑定的网卡
my $key = '1';												#指定vip绑定的虚拟网卡序列号
my $ssh_start_vip = "/sbin/ifconfig ens33:$key $vip";		#代表此变量值为ifconfig ens33:1 192.168.150.88
my $ssh_stop_vip = "/sbin/ifconfig ens33:$key down";		#代表此变量值为ifconfig ens33:1 192.168.150.88 down
my $exit_code = 0;											#指定退出状态码为0
#my $ssh_start_vip = "/usr/sbin/ip addr add $vip/24 brd $brdc dev $ifdev label $ifdev:$key;/usr/sbin/arping -q -A -c 1 -I $ifdev $vip;iptables -F;";
#my $ssh_stop_vip = "/usr/sbin/ip addr del $vip/24 dev $ifdev label $ifdev:$key";
##################################################################################
GetOptions(
'command=s' => \$command,
'ssh_user=s' => \$ssh_user,
'orig_master_host=s' => \$orig_master_host,
'orig_master_ip=s' => \$orig_master_ip,
'orig_master_port=i' => \$orig_master_port,
'new_master_host=s' => \$new_master_host,
'new_master_ip=s' => \$new_master_ip,
'new_master_port=i' => \$new_master_port,
);
 
exit &main();
 
sub main {
 
print "\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n";
 
if ( $command eq "stop" || $command eq "stopssh" ) {
 
my $exit_code = 1;
eval {
print "Disabling the VIP on old master: $orig_master_host \n";
&stop_vip();
$exit_code = 0;
};
if ($@) {
warn "Got Error: $@\n";
exit $exit_code;
}
exit $exit_code;
}
elsif ( $command eq "start" ) {
 
my $exit_code = 10;
eval {
print "Enabling the VIP - $vip on the new master - $new_master_host \n";
&start_vip();
$exit_code = 0;
};
if ($@) {
warn $@;
exit $exit_code;
}
exit $exit_code;
}
elsif ( $command eq "status" ) {
print "Checking the Status of the script.. OK \n";
exit 0;
}
else {
&usage();
exit 1;
}
}
sub start_vip() {
`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;
}
## A simple system call that disable the VIP on the old_master
sub stop_vip() {
`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;
}
sub usage {
print
"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";
}
[root@localhost ~]# chmod +x /usr/local/bin/master_ip_failover 

#更改manager配置文件
vi /etc/mha/app1.cnf
添加：
master_ip_failover_script=/usr/local/bin/master_ip_failover
注意：
[root@db03 ~]# dos2unix /usr/local/bin/master_ip_failover 
dos2unix: converting file /usr/local/bin/master_ip_failover to Unix format ...
[root@db03 ~]# chmod +x /usr/local/bin/master_ip_failover 

#主库上，手工生成第一个vip地址
手工在主库上绑定vip，注意一定要和配置文件中的ens33一致，我的是eth33:1(1是key指定的值)
[root@localhost ~]#ifconfig ens33:1 192.168.150.88/24

[root@localhost ~]#masterha_stop --conf=/etc/mha/app1.cnf
[root@localhost ~]#nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover < /dev/null > /var/log/mha/app1/manager.log 2>&1 &


#故障模拟 
#停掉住的mysqld
[root@localhost ~]#systemctl stop mysqld
```

![](/images/posts/10_mysql/19.png)





```bash
#查看日志飘逸到41服务器上

Mon Mar 25 22:50:03 2024 - [info] Master failover to 192.168.150.141(192.168.150.141:3306) completed successfully.
Mon Mar 25 22:50:03 2024 - [info] Deleted server1 entry from /etc/mha/app1.cnf .
Mon Mar 25 22:50:03 2024 - [info] 

----- Failover Report -----

app1: MySQL Master failover 192.168.150.142(192.168.150.142:3306) to 192.168.150.141(192.168.150.141:3306) succeeded

Master 192.168.150.142(192.168.150.142:3306) is down!

Check MHA Manager logs at localhost.localdomain:/var/log/mha/app1/manager for details.

Started automated(non-interactive) failover.
Invalidated master IP address on 192.168.150.142(192.168.150.142:3306)
The latest slave 192.168.150.141(192.168.150.141:3306) has all relay logs for recovery.
Selected 192.168.150.141(192.168.150.141:3306) as a new master.
192.168.150.141(192.168.150.141:3306): OK: Applying all logs succeeded.
192.168.150.141(192.168.150.141:3306): OK: Activated master IP address.
192.168.150.143(192.168.150.143:3306): This host has the latest relay log events.
Generating relay diff files from the latest slave succeeded.
192.168.150.143(192.168.150.143:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.150.141(192.168.150.141:3306)
192.168.150.141(192.168.150.141:3306): Resetting slave info succeeded.
Master failover to 192.168.150.141(192.168.150.141:3306) completed successfully.
```



![](/images/posts/10_mysql/20.png)



```bash
#验证
[root@localhost app1]# mysql -uroot -p123
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 121
Server version: 5.7.25-log MySQL Community Server (GPL)

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.150.141
                  Master_User: repl
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 154
               Relay_Log_File: localhost-relay-bin.000002
                Relay_Log_Pos: 320
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
```



# 11：MySQL-分布式架构-MyCAT:

## 11.1: MyCAT基础架构图:

![](/images/posts/10_mysql/21.png)





![](/images/posts/10_mysql/22.png)



## 11.2: MyCAT基础架构准备:

### 11.2.1: 环境准备:

```bash
两台虚拟机 db01 db02
每台创建四个mysql实例: 3308 3308 3309  3310

#删除历史环境:
[root@localhost ~]# pkill mysqld
[root@localhost ~]# rm -rf /data/*
[root@localhost ~]# mv /etc/my.cnf{,back}
```



### 11.2.2: 创建相关目录初始化数据:

```bash
[root@localhost ~]#mkdir /data/33{07..10}/data -p
[root@localhost ~]#chown -R mysql.mysql /data/
[root@localhost ~]#mysqld --initialize-insecure  --user=mysql --datadir=/data/3307/data --basedir=/app/mysql
[root@localhost ~]#mysqld --initialize-insecure  --user=mysql --datadir=/data/3308/data --basedir=/app/mysql
[root@localhost ~]#mysqld --initialize-insecure  --user=mysql --datadir=/data/3309/data --basedir=/app/mysql
[root@localhost ~]#mysqld --initialize-insecure  --user=mysql --datadir=/data/3310/data --basedir=/app/mysql
```



### 11.2.3: 准备配置文件和启动脚本:

```bash
========db01==============
cat >/data/3307/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3307/data
socket=/data/3307/mysql.sock
port=3307
log-error=/data/3307/mysql.log
log_bin=/data/3307/mysql-bin
binlog_format=row
skip-name-resolve
server-id=7
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat >/data/3308/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3308/data
port=3308
socket=/data/3308/mysql.sock
log-error=/data/3308/mysql.log
log_bin=/data/3308/mysql-bin
binlog_format=row
skip-name-resolve
server-id=8
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat >/data/3309/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3309/data
socket=/data/3309/mysql.sock
port=3309
log-error=/data/3309/mysql.log
log_bin=/data/3309/mysql-bin
binlog_format=row
skip-name-resolve
server-id=9
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF
cat >/data/3310/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3310/data
socket=/data/3310/mysql.sock
port=3310
log-error=/data/3310/mysql.log
log_bin=/data/3310/mysql-bin
binlog_format=row
skip-name-resolve
server-id=10
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat >/etc/systemd/system/mysqld3307.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf
LimitNOFILE = 5000
EOF

cat >/etc/systemd/system/mysqld3308.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf
LimitNOFILE = 5000
EOF

cat >/etc/systemd/system/mysqld3309.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf
LimitNOFILE = 5000
EOF
cat >/etc/systemd/system/mysqld3310.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3310/my.cnf
LimitNOFILE = 5000
EOF
========db02===============
cat >/data/3307/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3307/data
socket=/data/3307/mysql.sock
port=3307
log-error=/data/3307/mysql.log
log_bin=/data/3307/mysql-bin
binlog_format=row
skip-name-resolve
server-id=17
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF
cat >/data/3308/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3308/data
port=3308
socket=/data/3308/mysql.sock
log-error=/data/3308/mysql.log
log_bin=/data/3308/mysql-bin
binlog_format=row
skip-name-resolve
server-id=18
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF
cat >/data/3309/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3309/data
socket=/data/3309/mysql.sock
port=3309
log-error=/data/3309/mysql.log
log_bin=/data/3309/mysql-bin
binlog_format=row
skip-name-resolve
server-id=19
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF


cat >/data/3310/my.cnf<<EOF
[mysqld]
basedir=/app/mysql
datadir=/data/3310/data
socket=/data/3310/mysql.sock
port=3310
log-error=/data/3310/mysql.log
log_bin=/data/3310/mysql-bin
binlog_format=row
skip-name-resolve
server-id=20
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat >/etc/systemd/system/mysqld3307.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf
LimitNOFILE = 5000
EOF

cat >/etc/systemd/system/mysqld3308.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf
LimitNOFILE = 5000
EOF

cat >/etc/systemd/system/mysqld3309.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf
LimitNOFILE = 5000
EOF
cat >/etc/systemd/system/mysqld3310.service<<EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/app/mysql/bin/mysqld --defaults-file=/data/3310/my.cnf
LimitNOFILE = 5000
EOF
```



### 11.2.4: 修改权限，启动多实例:

```bash
[root@localhost ~]#chown -R mysql.mysql /data/*
[root@localhost ~]#systemctl start mysqld3307
[root@localhost ~]#systemctl start mysqld3308
[root@localhost ~]#systemctl start mysqld3309
[root@localhost ~]#systemctl start mysqld3310

[root@localhost ~]#mysql -S /data/3307/mysql.sock -e "show variables like 'server_id'"
[root@localhost ~]#mysql -S /data/3308/mysql.sock -e "show variables like 'server_id'"
[root@localhost ~]#mysql -S /data/3309/mysql.sock -e "show variables like 'server_id'"
[root@localhost ~]#mysql -S /data/3310/mysql.sock -e "show variables like 'server_id'"
```



### 11.2.5：节点主从规划:

```bash
箭头指向谁是主库
    192.168.150.141:3307    <----->  192.168.150.142:3307
    192.168.150.141:3309    ------>  192.168.150.141:3307
   192.168.150.142:3309    ------>  192.168.150.142:3307

    192.168.150.142:3308  <----->    192.168.150.141:3308
    192.168.150.142:3310  ----->     192.168.150.142:3308
  192.168.150.141:3310  ----->     192.168.150.141:3308
  
  
  #分片规划
  
  shard1:
		Master: 192.168.150.141:3307
		slave1: 192.168.150.141:3309
		standby Master: 192.168.150.142::3307
		slave2: 192.168.150.142:3309
  shard2:
  		Master: 192.168.150.142:3308
  		slave:1 192.168.150.142:3310
  		standby Master: 192.168.150.141:3308
  		slave2: 192.168.150.141:3310
```



### 11.2.6: 开始配置:



```bash
#shar1
192.168.150.141:3307	<------> 192.168.150.142:3307
#db02
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "grant replication slave on *.* to repl@'192.168.150.%' identified by '123';"
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "grant all on *.* to root@'192.168.150.%' identified by '123' with grant option;"

#db01
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.142',MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"

[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "show slave status\G;"
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

#db02
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.141',MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3307/mysql.sock -e "show slave status\G;"
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
            
            
            
            
 192.169.150.141:3309 ------>192.168.150.141:3307
 db01
 [root@localhost ~]# mysql -S /data/3309/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.141',MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
[root@localhost ~]# mysql -S /data/3309/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3309/mysql.sock -e "show slave status\G;"



192.168.150.142:3309 ----> 192.168.150.142:3307
 [root@localhost ~]# mysql -S /data/3309/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.142',MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
 [root@localhost ~]# mysql -S /data/3309/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3309/mysql.sock -e "show slave status\G;"



#shared2
192.168.150.141:3308 <-----> 192.168.150.142:3308
db01
 [root@localhost ~]#mysql -S /data/3308/mysql.sock -e "grant replication slave on *.* to repl@'192.168.150.%' identified by '123';"
  [root@localhost ~]#mysql -S /data/3308/mysql.sock -e "grant all on *.* to root@'192.168.150.%' identified by '123' with grant option;"
  
db02:
 [root@localhost ~]# mysql -S /data/3308/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.141',MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
  [root@localhost ~]# mysql -S /data/3308/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3308/mysql.sock -e "show slave status\G;"

db01:
 [root@localhost ~]# mysql -S /data/3308/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.142',MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
  [root@localhost ~]# mysql -S /data/3308/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3308/mysql.sock -e "show slave status\G;"



192.168.150.142:3310 ---->192.168.150.142:3308
db02
[root@localhost ~]# mysql -S /data/3310/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.142',MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
  [root@localhost ~]# mysql -S /data/3310/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3310/mysql.sock -e "show slave status\G;"



192.168.150.141:3310 -----> 192.168.150.141:3308
db01
[root@localhost ~]# mysql -S /data/3310/mysql.sock -e "CHANGE MASTER TO MASTER_HOST='192.168.150.141',MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';"
  [root@localhost ~]# mysql -S /data/3310/mysql.sock -e "start slave;"
[root@localhost ~]# mysql -S /data/3310/mysql.sock -e "show slave status\G;"


```



#### 11.2.6.1: 检测主从状态:

```bash
mysql -S /data/3307/mysql.sock -e "show slave status\G"|grep Yes
mysql -S /data/3308/mysql.sock -e "show slave status\G"|grep Yes
mysql -S /data/3309/mysql.sock -e "show slave status\G"|grep Yes
mysql -S /data/3310/mysql.sock -e "show slave status\G"|grep Yes

#注：如果中间出现错误，在每个节点进行执行以下命令
mysql -S /data/3307/mysql.sock -e "stop slave; reset slave all;"
mysql -S /data/3308/mysql.sock -e "stop slave; reset slave all;"
mysql -S /data/3309/mysql.sock -e "stop slave; reset slave all;"
mysql -S /data/3310/mysql.sock -e "stop slave; reset slave all;"
```





### 11.2.7: MySQL分布式架构介绍:



![](/images/posts/10_mysql/23.png)



```bash
1.schema拆分及业务分库
2.垂直拆分-分库分表
3.水平拆分-分片
```



## 11.3: MyCAT安装:

### 11.3.1: 预先安装java运行环境:

```bash
[root@localhost ~]# yum -y install java

#下载Macat
#下载地址:https://github.com/MyCATApache/Mycat-Server/releases
[root@localhost app]#wget https://github.com/MyCATApache/Mycat-Server/releases/download/Mycat-server-1675-release/Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz
[root@localhost app]# tar -xf Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz 
[root@localhost app]# cd mycat/
#软件目录结构
[root@localhost mycat]# ls
bin  catlet  conf  lib  version.txt
```



### 11.3.2: 启动和连接:

```bash
#配置环境变量
[root@localhost mycat]#vim /etc/profile
export PATH=/app/mycat/bin:$PATH
[root@localhost mycat]#source /etc/profile
#启动
Starting Mycat-server...
#连接mycat
[root@localhost mycat]# mysql -uroot -p123456 -h 127.0.0.1 -P8066
```



### 11.3.3: 配置文件介绍:

```bash
#logs目录
mycat.log   -----> mycat详细工作日志
wrapper.log  ----> mycat启动日志

#conf目录:
schema.xml  主配置文件(读写分离、高可用、分布式策略定制、节点控制)
server.xml	mycat软件本身相关的配置
rule.xml	分片规则配置文件，记录分片规则列表、使用方法等
#bin 可执行命令
#lib 存放jar包
#tmlogs: 临时日志
#version.txt版本信息


#Mycat常用命令操作
mycat start           #启动MyCat
mycat stop            #停止MyCat
mycat console         #前台运行MyCat带控制台输出
mycat restart         #重启MyCat
mycat pause           #暂停MyCat
mycat status          #查看启动状态
```



## 11.4: 应用前环境准备:

```bash
#用户创建及数据库导入
db01
[root@localhost ~]# mysql -S /data/3307/mysql.sock
mysql>grant all on *.* to root@'192.168.150.%' identified by '123';
mysql>source /root/qdataexa-insight-microservice-poc.sql

[root@localhost ~]# mysql -S /data/3308/mysql.sock
mysql>grant all on *.* to root@'192.168.150.%' identified by '123';
mysql>source /root/qdataexa-insight-microservice-poc.sql
```



### 11.4.1: 配置文件处理:



```bash
[root@localhost conf]# cd /app/mycat/conf/
[root@localhost conf]# mv schema.xml schema.xml-back
[root@localhost conf]# vim schema.xml
<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="dataexa-insight-microservice-poc" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
</schema>  
    <dataNode name="dn1" dataHost="localhost1" database= "dataexa-insight-microservice-pocs" />  
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
        <heartbeat>select user()</heartbeat>  
    <writeHost host="db1" url="192.168.150.141:3307" user="root" password="123"> 
            <readHost host="db2" url="192.168.150.141:3309" user="root" password="123" /> 
    </writeHost> 
    </dataHost>  
</mycat:schema>


#重启mycat

#启动报错
tail wrapper.log 
INFO   | jvm 1    | 2024/04/07 16:49:17 | Caused by: io.mycat.config.util.ConfigException: SelfCheck###  schema TESTDB refered by user root is not exist!

原因是schema.xml中的逻辑库要与server.xml中的数据库名字保持一致
#修改server.xml中的数据库名重新启动mycat

```



#### 11.4.1.1: 配置文件介绍:

```bash
#逻辑库: schema

<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
</schema>  
#参数详解:
schema：逻辑库 name ：逻辑库名称
sqlMaxLimit：一次取多少条数据
table：逻辑表
dataNode：数据节点 对应 datanode标签
rule：分片规则 对应 rule.xml
primaryKey: 分片主键 可缓存

#数据节点:datanode
<dataNode name="dn1" dataHost="localhost1" database= "dataexa-insight-microservice-pocs" />  
#分片参数详解
name：分片名字
dataHost：分片主机
database：分片数据库

#数据主机: datahost(w和r)
#配置读写分离
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
        <heartbeat>select user()</heartbeat>  
    <writeHost host="db1" url="192.168.150.141:3307" user="root" password="123"> 
            <readHost host="db2" url="192.168.150.141:3309" user="root" password="123" /> 
    </writeHost> 
    </dataHost> 
    
#参数:
dataHost：数据主机（节点主机）
dbType：数据库驱动native:MySQL JDBC: oracle SQLServer
switchType： 是否主动读 1
Balance参数设置：
1、 balance=“0”, 所有读操作都发送到当前可⽤的writeHost上。
2、 balance=“1”，所有读操作都随机的发送到readHost。
3、 balance=“2”，所有读操作都随机的在writeHost、readhost上分发
WriteType参数设置：
1、 writeType=“0”, 所有写操作都发送到可⽤的writeHost上。
2、 writeType=“1”，所有写操作都随机的发送到readHost。
3、 writeType=“2”，所有写操作都随机的在writeHost、readhost分上发。
witchType参数设置：
1、 switchType="1", 主从自动切换
2、 switchType="2"，从机延时超过slaveThreshold值时切换为主读
```



#### 11.4.2：读写分离测试:

```bash
[root@localhost ~]# mysql -uroot -p -h 127.0.0.1 -P8066
mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 9     |
+---------------+-------+
1 row in set (0.00 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 7     |
+---------------+-------+
1 row in set (0.00 sec)


总结： 
以上案例实现了1主1从的读写分离功能，写操作落到主库，读操作落到从库.如果主库宕机，从库不能在继续提供服务了。

#停掉主库
systemctl stop mysqld3307 
#测试 
mysql> show variables like 'server_id';
ERROR 1184 (HY000): java.net.ConnectException: Connection refused
mysql> show variables like 'server_id';

```





### 11.4.2：配置读写分离及高可用:

```bash
[root@localhost conf]# cp schema.xml schema.xml.rw
[root@localhost conf]# cat schema.xml
<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="dataexa-insight-microservice-poc" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
</schema>  
    <dataNode name="dn1" dataHost="localhost1" database= "dataexa-insight-microservice-poc" />  
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
        <heartbeat>select user()</heartbeat>  
    <writeHost host="db1" url="192.168.150.141:3307" user="root" password="123"> 
            <readHost host="db2" url="192.168.150.141:3309" user="root" password="123" /> 
    </writeHost> 
    <writeHost host="db3" url="192.168.150.142:3307" user="root" password="123"> 
            <readHost host="db4" url="192.168.150.142:3309" user="root" password="123" /> 
    </writeHost> 
    </dataHost>  
</mycat:schema>

[root@localhost conf]# mycat restart
Stopping Mycat-server...
Mycat-server was not running.
Starting Mycat-server...

#真正的 writehost：负责写操作的writehost  
#standby  writeHost  ：和readhost一样，只提供读服务

#当写节点宕机后，后面跟的readhost也不提供服务，这时候standby的writehost就提供写服务，
#后面跟的readhost提供读服务

#测试
mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 17    |
+---------------+-------+
1 row in set (0.01 sec)

mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 19    |
+---------------+-------+
1 row in set (0.00 sec)

mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 9     |
+---------------+-------+
1 row in set (0.00 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 7     |
+---------------+-------+


#对db01 3307节点进行关闭和启动，测试读写操作
[root@localhost ~]# systemctl stop mysqld3307

[root@localhost conf]# mysql -uroot -p123456 -h 127.0.0.1 -P8066
mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 19    |
+---------------+-------+
1 row in set (0.00 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> show variables like 'server_id';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 17    |
+---------------+-------+
1 row in set (0.01 sec)

```



### 11.4.3：配置中的属性介绍:

#### 11.4.3.1: balace属性:

```bash
负载均衡类型，目前的取值有3种： 
1. balance="0", 不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。 
2. balance="1"，全部的readHost与standby writeHost参与select语句的负载均衡，简单的说，
  当双主双从模式(M1->S1，M2->S2，并且M1与 M2互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。 
3. balance="2"，所有读操作都随机的在writeHost、readhost上分发。
```



#### 11.4.3.2：writeType属性:

```bash
负载均衡类型，目前的取值有2种： 
1. writeType="0", 所有写操作发送到配置的第一个writeHost，
第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为主，切换记录在配置文件中:dnindex.properties . 
2. writeType=“1”，所有写操作都随机的发送到配置的writeHost，但不推荐使用
```



#### 11.4.3.3: switchType属性：

```bash
-1 表示不自动切换 
1 默认值，自动切换 
2 基于MySQL主从同步的状态决定是否切换 ，心跳语句为 show slave status 
```



#### 11.4.3.4: datahost其它配置:

```bash
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 

maxCon="1000"：最大的并发连接数
minCon="10" ：mycat在启动之后，会在后端节点上自动开启的连接线程
tempReadHostAvailable="1"
这个一主一从时（1个writehost，1个readhost时），可以开启这个参数，如果2个writehost，2个readhost时
<heartbeat>select user()</heartbeat>  监测心跳
```



### 11.4.4: 垂直分表:

```bash
[root@localhost conf]# cat schema.xml
<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="dataexa-insight-microservice-poc" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
	<table name="user" dataNode="dn1"/>
        <table name="order_t" dataNode="dn2"/>
</schema>  
    <dataNode name="dn1" dataHost="db1" database= "dataexa-insight-microservice-poc" />  
    <dataNode name="dn2" dataHost="db2" database= "taobao" />  
    <dataHost name="db1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
        <heartbeat>select user()</heartbeat>  
    <writeHost host="dh1" url="192.168.150.141:3307" user="root" password="123"> 
            <readHost host="dh2" url="192.168.150.141:3309" user="root" password="123" /> 
    </writeHost> 
    <writeHost host="dh3" url="192.168.150.142:3307" user="root" password="123"> 
            <readHost host="dh4" url="192.168.150.142:3309" user="root" password="123" /> 
    </writeHost> 
    </dataHost>  
    <dataHost name="db2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
        <heartbeat>select user()</heartbeat>  
    <writeHost host="dh1" url="192.168.150.141:3308" user="root" password="123"> 
            <readHost host="dh2" url="192.168.150.141:3310" user="root" password="123" /> 
    </writeHost> 
    <writeHost host="dh3" url="192.168.150.142:3308" user="root" password="123"> 
            <readHost host="dh4" url="192.168.150.142:3310" user="root" password="123" /> 
    </writeHost> 
    </dataHost>  
</mycat:schema>

#db01
#已有dataexa-insight-microservice-poc 库 无需创建
[root@localhost conf]# mysql -S /data/3308/mysql.sock -e "create database taobao charset utf8;"
[root@localhost conf]# mysql -S /data/3307/mysql.sock -e "use dataexa-insight-microservice-poc;create table user(id int,name varchar(20))";
[root@localhost conf]# mysql -S /data/3308/mysql.sock -e "use taobao;create table order_t(id int,name varchar(20))"

#重启mycat
[root@localhost conf]# mycat restart

#登录mycat插入数据
[root@localhost conf]# mysql -uroot -p123456 -P8066 -h 127.0.0.1
mysql> use dataexa-insight-microservice-poc;
mysql> insert into user values(1,'zs');
mysql> insert into user values(2,'ls');
mysql> insert into  order_t values(2,'ls');
mysql> insert into  order_t values(1,'zs');


#db01验证数据
[root@localhost ~]# mysql -S /data/3307/mysql.sock
mysql> use dataexa-insight-microservice-poc ;
mysql> select * from user;
+------+------+
| id   | name |
+------+------+
|    1 | zs   |
|    2 | ls   |
+------+------+
2 rows in set (0.00 sec)
[root@localhost ~]# mysql -S /data/3308/mysql.sock
mysql> use taobao;
mysql> select * from order_t;
+------+------+
| id   | name |
+------+------+
|    2 | ls   |
|    1 | zs   |
+------+------+
2 rows in set (0.00 sec)

```

